/*! For license information please see background.js.LICENSE.txt */
(()=>{var e={265:(e,t,r)=>{"use strict";e=r.nmd(e);const a=(e=0)=>t=>`[${38+e};5;${t}m`,n=(e=0)=>(t,r,a)=>`[${38+e};2;${t};${r};${a}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[r,a]of Object.entries(t)){for(const[r,n]of Object.entries(a))t[r]={open:`[${n[0]}m`,close:`[${n[1]}m`},a[r]=t[r],e.set(n[0],n[1]);Object.defineProperty(t,r,{value:a,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=a(),t.color.ansi16m=n(),t.bgColor.ansi256=a(10),t.bgColor.ansi16m=n(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map((e=>e+e)).join(""));const a=Number.parseInt(r,16);return[a>>16&255,a>>8&255,255&a]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},9742:(e,t)=>{"use strict";t.byteLength=function(e){var t=o(e),r=t[0],a=t[1];return 3*(r+a)/4-a},t.toByteArray=function(e){var t,r,i=o(e),s=i[0],l=i[1],c=new n(function(e,t,r){return 3*(t+r)/4-r}(0,s,l)),u=0,h=l>0?s-4:s;for(r=0;r<h;r+=4)t=a[e.charCodeAt(r)]<<18|a[e.charCodeAt(r+1)]<<12|a[e.charCodeAt(r+2)]<<6|a[e.charCodeAt(r+3)],c[u++]=t>>16&255,c[u++]=t>>8&255,c[u++]=255&t;return 2===l&&(t=a[e.charCodeAt(r)]<<2|a[e.charCodeAt(r+1)]>>4,c[u++]=255&t),1===l&&(t=a[e.charCodeAt(r)]<<10|a[e.charCodeAt(r+1)]<<4|a[e.charCodeAt(r+2)]>>2,c[u++]=t>>8&255,c[u++]=255&t),c},t.fromByteArray=function(e){for(var t,a=e.length,n=a%3,i=[],s=16383,o=0,c=a-n;o<c;o+=s)i.push(l(e,o,o+s>c?c:o+s));return 1===n?(t=e[a-1],i.push(r[t>>2]+r[t<<4&63]+"==")):2===n&&(t=(e[a-2]<<8)+e[a-1],i.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),i.join("")};for(var r=[],a=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)r[s]=i[s],a[i.charCodeAt(s)]=s;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e,t,a){for(var n,i,s=[],o=t;o<a;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(r[(i=n)>>18&63]+r[i>>12&63]+r[i>>6&63]+r[63&i]);return s.join("")}a["-".charCodeAt(0)]=62,a["_".charCodeAt(0)]=63},7513:e=>{e.exports=function(e,t,r,a,n){var i,s;if(void 0===a)a=0;else if((a|=0)<0||a>=e.length)throw new RangeError("invalid lower bound");if(void 0===n)n=e.length-1;else if((n|=0)<a||n>=e.length)throw new RangeError("invalid upper bound");for(;a<=n;)if((s=+r(e[i=a+(n-a>>>1)],t,i,e))<0)a=i+1;else{if(!(s>0))return i;n=i-1}return~a}},3204:e=>{"use strict";const t=/[\p{Lu}]/u,r=/[\p{Ll}]/u,a=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,s=new RegExp("^"+i.source),o=new RegExp(i.source+n.source,"gu"),l=new RegExp("\\d+"+n.source,"gu"),c=(e,n)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(n={pascalCase:!1,preserveConsecutiveUppercase:!1,...n},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const i=!1===n.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(n.locale),c=!1===n.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(n.locale);return 1===e.length?n.pascalCase?c(e):i(e):(e!==i(e)&&(e=((e,a,n)=>{let i=!1,s=!1,o=!1;for(let l=0;l<e.length;l++){const c=e[l];i&&t.test(c)?(e=e.slice(0,l)+"-"+e.slice(l),i=!1,o=s,s=!0,l++):s&&o&&r.test(c)?(e=e.slice(0,l-1)+"-"+e.slice(l-1),o=s,s=!1,i=!0):(i=a(c)===c&&n(c)!==c,o=s,s=n(c)===c&&a(c)!==c)}return e})(e,i,c)),e=e.replace(s,""),e=n.preserveConsecutiveUppercase?((e,t)=>(a.lastIndex=0,e.replace(a,(e=>t(e)))))(e,i):i(e),n.pascalCase&&(e=c(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,l.lastIndex=0,e.replace(o,((e,r)=>t(r))).replace(l,(e=>t(e)))))(e,c))};e.exports=c,e.exports.default=c},2466:e=>{"use strict";e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},6729:e=>{"use strict";var t=Object.prototype.hasOwnProperty,r="~";function a(){}function n(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,a,i,s){if("function"!=typeof a)throw new TypeError("The listener must be a function");var o=new n(a,i||e,s),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new a:delete e._events[t]}function o(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,a,n=[];if(0===this._eventsCount)return n;for(a in e=this._events)t.call(e,a)&&n.push(r?a.slice(1):a);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=r?r+e:e,a=this._events[t];if(!a)return[];if(a.fn)return[a.fn];for(var n=0,i=a.length,s=new Array(i);n<i;n++)s[n]=a[n].fn;return s},o.prototype.listenerCount=function(e){var t=r?r+e:e,a=this._events[t];return a?a.fn?1:a.length:0},o.prototype.emit=function(e,t,a,n,i,s){var o=r?r+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,a),!0;case 4:return u.fn.call(u.context,t,a,n),!0;case 5:return u.fn.call(u.context,t,a,n,i),!0;case 6:return u.fn.call(u.context,t,a,n,i,s),!0}for(c=1,l=new Array(h-1);c<h;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var d,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),h){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,a);break;case 4:u[c].fn.call(u[c].context,t,a,n);break;default:if(!l)for(d=1,l=new Array(h-1);d<h;d++)l[d-1]=arguments[d];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,a,n){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||n&&!o.once||a&&o.context!==a||s(this,i);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||n&&!o[l].once||a&&o[l].context!==a)&&c.push(o[l]);c.length?this._events[i]=1===c.length?c[0]:c:s(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new a,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o},6563:(e,t)=>{"use strict"},7345:e=>{"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},5860:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(6729),n=r(8147),i=r(6506),s=()=>{},o=new n.TimeoutError;t.default=class extends a{constructor(e){var t,r,a,n;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=s,this._resolveIdle=s,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:i.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(r=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==r?r:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(n=null===(a=e.interval)||void 0===a?void 0:a.toString())&&void 0!==n?n:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((r,a)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const i=void 0===this._timeout&&void 0===t.timeout?e():n.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&a(o)}));r(await i)}catch(e){a(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},7489:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){let a=0,n=e.length;for(;n>0;){const i=n/2|0;let s=a+i;r(e[s],t)<=0?(a=++s,n-=i+1):n=i}return a}},6506:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=r(7489);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const r={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(r);const n=a.default(this._queue,r,((e,t)=>t.priority-e.priority));this._queue.splice(n,0,r)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},2693:(e,t,r)=>{"use strict";const a=r(9353),n=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class i extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const s=(e,t)=>new Promise(((r,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=a.operation(t);o.attempt((async a=>{try{r(await e(a))}catch(e){if(!(e instanceof Error))return void s(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof i)o.stop(),s(e.originalError);else if(e instanceof TypeError&&(l=e.message,!n.includes(l)))o.stop(),s(e);else{((e,t,r)=>{const a=r.retries-(t-1);e.attemptNumber=t,e.retriesLeft=a})(e,a,t);try{await t.onFailedAttempt(e)}catch(e){return void s(e)}o.retry(e)||s(o.mainError())}}var l}))}));e.exports=s,e.exports.default=s,e.exports.AbortError=i},8147:(e,t,r)=>{"use strict";const a=r(7345);class n extends Error{constructor(e){super(e),this.name="TimeoutError"}}const i=(e,t,r)=>new Promise(((i,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void i(e);const o=setTimeout((()=>{if("function"==typeof r){try{i(r())}catch(e){s(e)}return}const a=r instanceof Error?r:new n("string"==typeof r?r:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(a)}),t);a(e.then(i,s),(()=>{clearTimeout(o)}))}));e.exports=i,e.exports.default=i,e.exports.TimeoutError=n},9353:(e,t,r)=>{e.exports=r(1846)},1846:(e,t,r)=>{var a=r(1960);t.operation=function(e){var r=t.timeouts(e);return new a(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],n=0;n<t.retries;n++)a.push(this.createTimeout(n,t));return e&&e.forever&&!a.length&&a.push(this.createTimeout(n,t)),a.sort((function(e,t){return e-t})),a},t.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,a=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(a,t.maxTimeout)},t.wrap=function(e,r,a){if(r instanceof Array&&(a=r,r=null),!a)for(var n in a=[],e)"function"==typeof e[n]&&a.push(n);for(var i=0;i<a.length;i++){var s=a[i],o=e[s];e[s]=function(a){var n=t.operation(r),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push((function(e){n.retry(e)||(e&&(arguments[0]=n.mainError()),s.apply(this,arguments))})),n.attempt((function(){a.apply(e,i)}))}.bind(e,o),e[s].options=r}}},1960:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var a=this;return this._timer=setTimeout((function(){a._attempts++,a._operationTimeoutCb&&(a._timeout=setTimeout((function(){a._operationTimeoutCb(a._attempts)}),a._operationTimeout),a._options.unref&&a._timeout.unref()),a._fn(a._attempts)}),r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,a=0;a<this._errors.length;a++){var n=this._errors[a],i=n.message,s=(e[i]||0)+1;e[i]=s,s>=r&&(t=n,r=s)}return t}},8721:(e,t,r)=>{"use strict";r.d(t,{Z:()=>l});const a={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let n;const i=new Uint8Array(16);function s(){if(!n&&(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(i)}const o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));const l=function(e,t,r){if(a.randomUUID&&!t&&!e)return a.randomUUID();const n=(e=e||{}).random||(e.rng||s)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=n[e];return t}return function(e,t=0){return o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]}(n)}},6515:(e,t,r)=>{"use strict";r.d(t,{E:()=>s});var a=r(8721),n=r(6141);class i{}class s extends i{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,(0,n.j)(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"undefined"==typeof process||"true"!==process.env?.LANGCHAIN_CALLBACKS_BACKGROUND}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever)}copy(){return new this.constructor(this)}toJSON(){return n.i.prototype.toJSON.call(this)}toJSONNotImplemented(){return n.i.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends s{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a.Z()}),Object.assign(this,e)}}}}},238:(e,t,r)=>{"use strict";r.d(t,{Ye:()=>V,xz:()=>H,QH:()=>L});var a=r(8721),n=r(6515),i=r(7759);const s=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;var o=r(2693),l=r(5860);const c=[400,401,403,404,405,406,407,408],u=[409];class h{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const t=l.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>o((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status;if(t){if(c.includes(+t))throw e;if(u.includes(+t))return}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function d(e){return"function"==typeof e?._getType}function p(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}let m;const f=()=>"undefined"!=typeof Deno,g=()=>m||(m="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||f()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":f()?"deno":"other":"node",m);let b,y;function w(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}async function v(e){const t=await async function(){if(void 0===b){const e=g(),t=function(){if(void 0!==y)return y;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const e=w(r);void 0!==e&&(t[r]=e)}return y=t,t}();b={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:T,...t}}return b}(),r=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,r])=>(e[t]=String(r),e)),{}):void 0}catch(e){return}}()||{},t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[a,n]of Object.entries(e))!a.startsWith("LANGCHAIN_")||"string"!=typeof n||r.includes(a)||a.toLowerCase().includes("key")||a.toLowerCase().includes("secret")||a.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===a?t.revision_id=n:t[a]=n);return t}();return e.map((e=>{const a=e.extra??{},n=a.metadata;return e.extra={...a,runtime:{...t,...a?.runtime},metadata:{...r,...r.revision_id||e.revision_id?{revision_id:e.revision_id??r.revision_id}:{},...n}},e}))}const _=e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t},O=async(e,t)=>{const r=await e.text();if(!e.ok)throw new Error(`Failed to ${t}: ${e.status} ${e.statusText} ${r}`)};function x(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function P(e){if("string"!=typeof(t=e)||!s.test(t))throw new Error(`Invalid UUID: ${e}`);var t}class k{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise((t=>{this.items.push([e,t])}))}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const e=this.items.shift();if(!e)break;t.push(e)}return[t.map((e=>e[0])),()=>t.forEach((e=>e[1]()))]}}class E{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new k}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50});const t=E.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=w("LANGCHAIN_TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=x(e.apiUrl??t.apiUrl)??"",this.apiKey=x(e.apiKey??t.apiKey),this.webUrl=x(e.webUrl??t.webUrl),this.validateApiKeyIfHosted(),this.timeout_ms=e.timeout_ms??12e3,this.caller=new h(e.callerOptions??{}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit}static getDefaultClientConfig(){const e=w("LANGCHAIN_API_KEY");return{apiUrl:w("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===w("LANGCHAIN_HIDE_INPUTS"),hideOutputs:"true"===w("LANGCHAIN_HIDE_OUTPUTS")}}validateApiKeyIfHosted(){if(!_(this.apiUrl)&&!this.apiKey)throw new Error("API key must be provided when using hosted LangSmith API")}getHostUrl(){return this.webUrl?this.webUrl:_(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={"User-Agent":`langsmith-js/${T}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs?{}:e}processOutputs(e){return this.hideOutputs?{}:e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,n=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok)throw new Error(`Failed to fetch ${e}: ${n.status} ${n.statusText}`);return n}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));const n=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);const s=await i.json();if(0===s.length)break;if(yield s,s.length<a)break;r+=s.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const n=t?{...t}:{};for(;;){const t=await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(n)}),i=await t.json();if(!i)break;if(!i[a])break;yield i[a];const s=i.cursors;if(!s)break;if(!s.next)break;n.cursor=s.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const r of e)this.sampledPostUuids.has(r.id)&&(t.push(r),this.sampledPostUuids.delete(r.id));return t}{const t=[];for(const r of e)Math.random()<this.tracingSampleRate&&(t.push(r),this.sampledPostUuids.add(r.id));return t}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length)return void t();try{await this.batchIngestRuns({runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))})}finally{t()}}}async processRunOperation(e,t){const r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue()}),r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async batchEndpointIsSupported(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms)});return!!e.ok||(await e.text(),!1)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order)return void this.processRunOperation({action:"create",item:a});const n=await v([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(n[0]),signal:AbortSignal.timeout(this.timeout_ms)});await O(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let r=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],a=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(r.length>0&&a.length>0){const e=r.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const r of a)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);r=Object.values(e),a=t}const n={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!n.post.length&&!n.patch.length)return;if(r=await v(r),void 0===this.batchEndpointSupported&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const e of n.post)await this.createRun(e);for(const e of n.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const i={...this.headers,"Content-Type":"application/json",Accept:"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:i,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms)});await O(s,"batch create run")}async updateRun(e,t){P(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void 0!==t.end_time&&void 0===r.parent_run_id?void await this.processRunOperation({action:"update",item:r},!0):void this.processRunOperation({action:"update",item:r});const a={...this.headers,"Content-Type":"application/json"},n=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await O(n,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){P(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:w("LANGCHAIN_PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const r of e)t.push(r);return t}(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in r||(r[e.parent_run_id]=[]),r[e.parent_run_id].push(e),a[e.id]=e}e.child_runs=r[e.id]||[];for(const t in r)t!==e.id&&(a[t].child_runs=r[t]);return e}async*listRuns({projectId:e,projectName:t,parentRunId:r,traceId:a,referenceExampleId:n,startTime:i,executionOrder:s,runType:o,error:l,id:c,query:u,filter:h,limit:d}){let p=[];if(e&&(p=Array.isArray(e)?e:[e]),t){const e=Array.isArray(t)?t:[t],r=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));p.push(...r)}const m={session:p.length?p:null,run_type:o,reference_example:n,query:u,filter:h,execution_order:s,parent_run:r?[r]:null,start_time:i?i.toISOString():null,error:l,id:c,limit:d,trace:a};for await(const e of this._getCursorPaginatedList("/runs/query",m))yield*e}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||a.Z()};P(e);const n=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)}),i=await n.json();if(null===i||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){P(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await O(t,"unshare run")}async readRunSharedLink(e){P(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)r.append("id",e);P(e);const a=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});return await a.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),P(e);const r=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};P(e);const a=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)}),n=await a.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async unshareDataset(e){P(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await O(t,"unshare dataset")}async readSharedDataset(e){P(e);const t=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});return await t.json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:n=null,referenceDatasetId:i=null}){const s=a?"?upsert=true":"",o=`${this.apiUrl}/sessions${s}`,l=n||{};r&&(l.metadata=r);const c={name:e,extra:l,description:t};null!==i&&(c.reference_dataset_id=i);const u=await this.caller.call(fetch,o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)}),h=await u.json();if(!u.ok)throw new Error(`Failed to create session ${e}: ${u.status} ${u.statusText}`);return h}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:n=null,endTime:i=null}){const s=`${this.apiUrl}/sessions/${e}`;let o=n;a&&(o={...o||{},metadata:a});const l={name:t,extra:o,description:r,end_time:i?new Date(i).toISOString():null},c=await this.caller.call(fetch,s,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),u=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return u}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)P(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}const n=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});try{const e=await n.json();return!!n.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)P(e),a+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}void 0!==r&&n.append("include_stats",r.toString());const i=await this._get(a,n);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:n,referenceFree:i}={}){const s=new URLSearchParams;if(void 0!==e)for(const t of e)s.append("id",t);if(void 0!==t&&s.append("name",t),void 0!==r&&s.append("name_contains",r),void 0!==a)s.append("reference_dataset",a);else if(void 0!==n){const e=await this.readDataset({datasetName:n});s.append("reference_dataset",e.id)}void 0!==i&&s.append("reference_free",i.toString());for await(const e of this._getPaginated("/sessions",s))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");r=void 0===e?(await this.readProject({projectName:t})).id:e,P(r);const a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await O(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:n,dataType:i,name:s}){const o=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach((e=>{l.append("input_keys",e)})),a.forEach((e=>{l.append("output_keys",e)})),n&&l.append("description",n),i&&l.append("data_type",i),s&&l.append("name",s);const c=await this.caller.call(fetch,o,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms)});if(!c.ok){const e=await c.json();if(e.detail&&e.detail.includes("already exists"))throw new Error(`Dataset ${t} already exists`);throw new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){const a={name:e,description:t};r&&(a.data_type=r);const n=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok){const t=await n.json();if(t.detail&&t.detail.includes("already exists"))throw new Error(`Dataset ${e} already exists`);throw new Error(`Failed to create dataset ${n.status} ${n.statusText}`)}return await n.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)P(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");a.append("name",t)}const n=await this._get(r,a);let i;if(Array.isArray(n)){if(0===n.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=n[0]}else i=n;return i}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:n}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(const e of r)i.append("id",e);void 0!==a&&i.append("name",a),void 0!==n&&i.append("name_contains",n);for await(const e of this._getPaginated("/datasets",i))yield*e}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(a=(await this.readDataset({datasetName:t})).id),void 0===a)throw new Error("Must provide datasetName or datasetId");P(a),r+=`/${a}`;const n=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok)throw new Error(`Failed to delete ${r}: ${n.status} ${n.statusText}`);await n.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:n,exampleId:i}){let s=r;if(void 0===s&&void 0===a)throw new Error("Must provide either datasetName or datasetId");if(void 0!==s&&void 0!==a)throw new Error("Must provide either datasetName or datasetId, not both");void 0===s&&(s=(await this.readDataset({datasetName:a})).id);const o=n||new Date,l={dataset_id:s,inputs:e,outputs:t,created_at:o?.toISOString(),id:i},c=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)});if(!c.ok)throw new Error(`Failed to create example: ${c.status} ${c.statusText}`);return await c.json()}async createExamples(e){const{inputs:t,outputs:r,sourceRunIds:a,exampleIds:n,datasetId:i,datasetName:s}=e;let o=i;if(void 0===o&&void 0===s)throw new Error("Must provide either datasetName or datasetId");if(void 0!==o&&void 0!==s)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===o){const e=await this.readDataset({datasetName:s});o=e.id}const l=t.map(((e,t)=>({dataset_id:o,inputs:e,outputs:r?r[t]:void 0,id:n?n[t]:void 0,source_run_id:a?a[t]:void 0}))),c=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)});if(!c.ok)throw new Error(`Failed to create examples: ${c.status} ${c.statusText}`);return await c.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map((e=>d(e)?p(e):e)),n=d(t)?p(t):t;return this.createExample({input:a},{output:n},r)}async readExample(e){P(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r}={}){let a;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)a=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");a=(await this.readDataset({datasetName:t})).id}const n=new URLSearchParams({dataset:a});if(void 0!==r)for(const e of r)n.append("id",e);for await(const e of this._getPaginated("/examples",n))yield*e}async deleteExample(e){P(e);const t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){P(e);const r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:n}={loadChildRuns:!1}){let i;if("string"==typeof e)i=await this.readRun(e,{loadChildRuns:a});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(n=await this.readExample(i.reference_example_id));const s=await t.evaluateRun(i,n);let o=r??{};s.evaluatorInfo&&(o={...o,...s.evaluatorInfo});const l=s.targetRunId??i.id;return await this.createFeedback(l,s.key,{score:s?.score,value:s?.value,comment:s?.comment,correction:s?.correction,sourceInfo:o,feedbackSourceType:"model",sourceRunId:s?.sourceRunId})}async createFeedback(e,t,{score:r,value:n,correction:i,comment:s,sourceInfo:o,feedbackSourceType:l="api",sourceRunId:c,feedbackId:u,eager:h=!1}){const d={type:l??"api",metadata:o??{}};void 0===c||void 0===d?.metadata||d.metadata.__run||(d.metadata.__run={run_id:c}),void 0!==d?.metadata&&void 0!==d.metadata.__run?.run_id&&P(d.metadata.__run.run_id);const p={id:u??a.Z(),run_id:e,key:t,score:r,value:n,correction:i,comment:s,feedback_source:d},m=`${this.apiUrl}/feedback`+(h?"/eager":""),f=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms)});return await O(f,"create feedback"),p}async updateFeedback(e,{score:t,value:r,correction:a,comment:n}){const i={};null!=t&&(i.score=t),null!=r&&(i.value=r),null!=a&&(i.correction=a),null!=n&&(i.comment=n),P(e);const s=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms)});await O(s,"update feedback")}async readFeedback(e){P(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){P(e);const t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const e of t)a.append("key",e);if(r)for(const e of r)a.append("source",e);for await(const e of this._getPaginated("/feedback",a))yield*e}}const T="0.1.3",S=()=>"undefined"!=typeof Deno;let j;async function C(){if(void 0===j){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||S()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":S()?"deno":"other":"node",e})();j={library:"langchain-js",runtime:e}}return j}function A(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}var I=r(4075);class M extends I.Z{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??A("LANGCHAIN_PROJECT")??A("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new E({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await C()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}var R=r(3908);let N;async function $(e,t){!0===t?await e():(void 0===N&&(N=new(0,l.default)({autoStart:!0,concurrency:1})),N.add(e))}function L(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class U{setHandler(e){return this.setHandlers([e])}}class D{constructor(e,t,r,a,n,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map((t=>$((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`)}}),t.awaitHandlers))))}}class F extends D{getChild(e){const t=new V(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${e}`)}}),t.awaitHandlers))))}}class B extends D{async handleLLMNewToken(e,t,r,a,n,i){await Promise.all(this.handlers.map((r=>$((async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`)}}),r.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`)}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`)}}),t.awaitHandlers))))}}class z extends D{getChild(e){const t=new V(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,n){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`)}}),t.awaitHandlers))))}async handleChainEnd(e,t,r,a,n){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`)}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`)}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`)}}),t.awaitHandlers))))}}class q extends D{getChild(e){const t=new V(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`)}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>$((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`)}}),t.awaitHandlers))))}}class V extends U{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(t.map((async t=>{const r=(0,a.Z)();return await Promise.all(this.handlers.map((a=>$((async()=>{if(!a.ignoreLLM)try{await(a.handleLLMStart?.(e,[t],r,this._parentRunId,i,this.tags,this.metadata,l))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`)}}),a.awaitHandlers)))),new B(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(t.map((async t=>{const r=(0,a.Z)();return await Promise.all(this.handlers.map((a=>$((async()=>{if(!a.ignoreLLM)try{if(a.handleChatModelStart)await(a.handleChatModelStart?.(e,[t],r,this._parentRunId,i,this.tags,this.metadata,l));else if(a.handleLLMStart){const n=(0,R.zs)(t);await(a.handleLLMStart?.(e,[n],r,this._parentRunId,i,this.tags,this.metadata,l))}}catch(e){console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`)}}),a.awaitHandlers)))),new B(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,r=(0,a.Z)(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((a=>$((async()=>{if(!a.ignoreChain)try{await(a.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,n,o))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleChainStart: ${e}`)}}),a.awaitHandlers)))),new z(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=(0,a.Z)(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((a=>$((async()=>{if(!a.ignoreAgent)try{await(a.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleToolStart: ${e}`)}}),a.awaitHandlers)))),new q(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=(0,a.Z)(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((a=>$((async()=>{if(!a.ignoreRetriever)try{await(a.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleRetrieverStart: ${e}`)}}),a.awaitHandlers)))),new F(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new V(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const a of e)r.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===a.name))||r.addHandler(a,t);return r}static fromHandlers(e){class t extends n.E{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:(0,a.Z)()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,n,s,o){let l;(e||t)&&(Array.isArray(e)||!e?(l=new V,l.setHandlers(e?.map(H)??[],!0)):l=e,l=l.copy(Array.isArray(t)?t.map(H):t?.handlers,!1));const c="true"===A("LANGCHAIN_VERBOSE")||o?.verbose,u="true"===A("LANGCHAIN_TRACING_V2"),h=u||(A("LANGCHAIN_TRACING")??!1);if(c||h){if(l||(l=new V),c&&!l.handlers.some((e=>e.name===i.Z.prototype.name))){const e=new i.Z;l.addHandler(e,!0)}h&&!l.handlers.some((e=>"langchain_tracer"===e.name))&&u&&l.addHandler(await async function(){return new M}(),!0)}return(r||a)&&l&&(l.addTags(r??[]),l.addTags(a??[],!1)),(n||s)&&l&&(l.addMetadata(n??{}),l.addMetadata(s??{},!1)),l}}function H(e){return"name"in e?e:n.E.fromMethods(e)}},6141:(e,t,r)=>{"use strict";r.d(t,{i:()=>c,j:()=>l});var a=r(2466);function n(e,t){return t?.[e]||a(e)}function i(e,t,r){const a={};for(const n in e)Object.hasOwn(e,n)&&(a[t(n,r)]=e[n]);return a}function s(e){return Array.isArray(e)?[...e]:{...e}}function o(e,t){const r=s(e);for(const[e,a]of Object.entries(t)){const[t,...n]=e.split(".").reverse();let i=r;for(const e of n.reverse()){if(void 0===i[e])break;i[e]=s(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[a]})}return r}function l(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}r(3204);class c{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,l(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof c||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,a=r;const[n,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in a&&void 0!==a[e]||("object"==typeof t[e]&&null!=t[e]?a[e]={}:Array.isArray(t[e])&&(a[e]=[])),t=t[e],a=a[e]}n in t&&void 0!==t[n]&&(a[n]=a[n]||t[n])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:i(Object.keys(t).length?o(r,t):r,n,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}},3908:(e,t,r)=>{"use strict";r.d(t,{E1:()=>b,GC:()=>h,J:()=>f,QW:()=>g,gY:()=>u,jN:()=>d,ku:()=>i,xk:()=>l,zs:()=>w});var a=r(6141);function n(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?[...e,...t]:[...e,{type:"text",text:t}]}class i extends a.i{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if("human"===e)return new c({...this});if("ai"===e)return new h({...this});if("system"===e)return new p({...this});if("function"===e)return new m({...this});if(f.isInstance(this))return new y({...this});throw new Error("Unknown message type.")}}function s(e){return Array.isArray(e)&&e.every((e=>"number"==typeof e.index))}class o extends i{static _mergeAdditionalKwargs(e,t){const r={...e};for(const[e,a]of Object.entries(t))if(void 0===r[e])r[e]=a;else{if(typeof r[e]!=typeof a)throw new Error(`additional_kwargs[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof r[e])r[e]=r[e]+a;else if(Array.isArray(r[e])||"object"!=typeof r[e]){if("tool_calls"!==e||!s(r[e])||!s(a))throw new Error(`additional_kwargs[${e}] already exists in this message chunk.`);for(const t of a)void 0!==r[e]?.[t.index]?r[e]=r[e]?.map(((e,r)=>r!==t.index?e:{...e,...t,function:{name:t.function.name??e.function.name,arguments:(e.function.arguments??"")+(t.function.arguments??"")}})):r[e][t.index]=t}else r[e]=this._mergeAdditionalKwargs(r[e],a)}return r}}class l extends i{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class c extends o{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new c({content:n(this.content,e.content),additional_kwargs:c._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class u extends i{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class h extends o{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new h({content:n(this.content,e.content),additional_kwargs:h._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class d extends i{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class p extends o{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new p({content:n(this.content,e.content),additional_kwargs:p._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class m extends o{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new m({content:n(this.content,e.content),additional_kwargs:m._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:this.name??""})}}class f extends i{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return f}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}function g(e){return"function"==typeof e?._getType}function b(e){if("string"==typeof e)return new l(e);if(g(e))return e;const[t,r]=e;if("human"===t||"user"===t)return new l({content:r});if("ai"===t||"assistant"===t)return new u({content:r});if("system"===t)return new d({content:r});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}class y extends o{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new y({content:n(this.content,e.content),additional_kwargs:y._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function w(e,t="Human",r="AI"){const a=[];for(const n of e){let e;if("human"===n._getType())e=t;else if("ai"===n._getType())e=r;else if("system"===n._getType())e="System";else if("function"===n._getType())e="Function";else if("tool"===n._getType())e="Tool";else{if("generic"!==n._getType())throw new Error(`Got unsupported message type: ${n._getType()}`);e=n.role}const i=n.name?`${n.name}, `:"";a.push(`${e}: ${i}${n.content}`)}return a.join("\n")}},1141:(e,t,r)=>{"use strict";r.d(t,{GU:()=>o,Nn:()=>l,nw:()=>s});var a=r(6141),n=r(3908);class i extends a.i{}class s extends i{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new n.xk(this.value)]}}class o extends i{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return(0,n.zs)(this.messages)}toChatMessages(){return this.messages}}class l extends i{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new n.xk({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}},619:(e,t,r)=>{"use strict";r.d(t,{d:()=>n});var a=r(2608);class n extends a.eq{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[e,a]of Object.entries(t))r[e]="string"==typeof a?a:await a();return{...r,...e}}async invoke(e,t){return this._callWithConfig((e=>this.formatPromptValue(e)),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Promise.resolve().then(r.bind(r,1214));return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Promise.resolve().then(r.bind(r,1214));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Promise.resolve().then(r.bind(r,7315));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}},9242:(e,t,r)=>{"use strict";r.d(t,{ks:()=>v,ov:()=>y});var a=r(3908),n=r(1141),i=r(2608),s=r(1307),o=r(619),l=r(1214),c=r(6428),u=r(7327);class h extends i.eq{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig((e=>this.formatMessages(e)),e,{...t,runType:"prompt"})}}class d extends h{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class p extends o.d{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new n.GU(t)}}class m extends d{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new a.J(await this.prompt.format(e),this.role)}static fromTemplate(e,t){return new this(l.PromptTemplate.fromTemplate(e),t)}}class f extends h{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach((t=>{"inputVariables"in t&&(e=e.concat(t.inputVariables))})),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass())return new(t._messageClass())({content:e});if(t.chatMessageClass){const r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if("string"==typeof e)return new this(l.PromptTemplate.fromTemplate(e));const r=[];for(const t of e)if("string"==typeof t||"object"==typeof t&&"text"in t){let e="";"string"==typeof t?e=t:"string"==typeof t.text&&(e=t.text??""),r.push(l.PromptTemplate.fromTemplate(e))}else if("object"==typeof t&&"image_url"in t){let e,a=t.image_url??"",n=[];if("string"==typeof a){const t=(0,u._O)(a).flatMap((e=>"variable"===e.type?[e.name]:[]));if((t?.length??0)>0){if(t.length>1)throw new Error(`Only one format variable allowed per image template.\nGot: ${t}\nFrom: ${a}`);n=[t[0]]}else n=[];a={url:a},e=new c.r({template:a,inputVariables:n})}else{if("object"!=typeof a)throw new Error("Invalid image template");n="url"in a?(0,u._O)(a.url).flatMap((e=>"variable"===e.type?[e.name]:[])):[],e=new c.r({template:a,inputVariables:n})}r.push(e)}return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof s.A){const t=await this.prompt.format(e);return this.createMessage(t)}{const t=[];for(const r of this.prompt){let a={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(const t of r.inputVariables)a||(a={[t]:e[t]}),a={...a,[t]:e[t]};if(r instanceof s.A){const e=await r.format(a);t.push({type:"text",text:e})}else if(r instanceof c.r){const e=await r.format(a);t.push({type:"image_url",image_url:e})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}}class g extends f{static _messageClass(){return a.xk}static lc_name(){return"HumanMessagePromptTemplate"}}class b extends f{static _messageClass(){return a.gY}static lc_name(){return"AIMessagePromptTemplate"}}class y extends f{static _messageClass(){return a.jN}static lc_name(){return"SystemMessagePromptTemplate"}}function w(e){if("function"==typeof e.formatMessages||(0,a.QW)(e))return e;const t=(0,a.E1)(e);if("human"===t._getType())return g.fromTemplate(t.content);if("ai"===t._getType())return b.fromTemplate(t.content);if("system"===t._getType())return y.fromTemplate(t.content);if(a.J.isInstance(t))return m.fromTemplate(t.content,t.role);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}class v extends p{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){const e=new Set;for(const t of this.promptMessages)if(!(t instanceof a.ku))for(const r of t.inputVariables)e.add(r);const t=this.inputVariables,r=new Set(this.partialVariables?t.concat(Object.keys(this.partialVariables)):t),n=new Set([...r].filter((t=>!e.has(t))));if(n.size>0)throw new Error(`Input variables \`${[...n]}\` are not used in any of the prompt messages.`);const i=new Set([...e].filter((e=>!r.has(e))));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if("string"==typeof e.content)return e;const r=await Promise.all(e.content.map((async e=>{if("image_url"!==e.type)return e;let r="";r="string"==typeof e.image_url?e.image_url:e.image_url.url;const a=l.PromptTemplate.fromTemplate(r),n=await a.format(t);return"string"!=typeof e.image_url&&"url"in e.image_url?e.image_url.url=n:e.image_url=n,e})));return e.content=r,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let r=[];for(const e of this.promptMessages)if(e instanceof a.ku)r.push(await this._parseImagePrompts(e,t));else{const a=e.inputVariables.reduce(((r,a)=>{if(!(a in t||"MessagesPlaceholder"===e.constructor.lc_name()&&e.optional))throw new Error(`Missing value for input variable \`${a.toString()}\``);return r[a]=t[a],r}),{}),n=await e.formatMessages(a);r=r.concat(n)}return r}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new v(a)}static fromTemplate(e){const t=l.PromptTemplate.fromTemplate(e),r=new g({prompt:t});return this.fromMessages([r])}static fromMessages(e){const t=e.reduce(((e,t)=>e.concat(t instanceof v?t.promptMessages:[w(t)])),[]),r=e.reduce(((e,t)=>t instanceof v?Object.assign(e,t.partialVariables):e),Object.create(null)),n=new Set;for(const e of t)if(!(e instanceof a.ku))for(const t of e.inputVariables)t in r||n.add(t);return new v({inputVariables:[...n],promptMessages:t,partialVariables:r})}static fromPromptMessages(e){return this.fromMessages(e)}}},7315:(e,t,r)=>{"use strict";r.d(t,{FewShotPromptTemplate:()=>s});var a=r(1307),n=r(7327),i=r(1214);r(9242);class s extends a.A{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,n.af)(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new s(a)}async format(e){const t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),a=await Promise.all(r.map((e=>this.examplePrompt.format(e)))),i=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return(0,n.SM)(i,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");const r=await i.PromptTemplate.deserialize(t);let a;if(!Array.isArray(e.examples))throw new Error("Invalid examples format. Only list or string are supported.");return a=e.examples,new s({inputVariables:e.input_variables,examplePrompt:r,examples:a,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}},6428:(e,t,r)=>{"use strict";r.d(t,{r:()=>s});var a=r(1141),n=r(619),i=r(7327);class s extends n.d{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,i.af)([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new s(a)}async format(e){const t={};for(const[r,a]of Object.entries(this.template))t[r]="string"==typeof a?a.replace(/{([^{}]*)}/g,((t,r)=>{const a=e[r];return"string"==typeof a||"number"==typeof a?String(a):t})):a;const r=e.url||t.url,a=e.detail||t.detail;if(!r)throw new Error("Must provide either an image URL.");if("string"!=typeof r)throw new Error("url must be a string.");const n={url:r};return a&&(n.detail=a),n}async formatPromptValue(e){const t=await this.format(e);return new a.Nn(t)}}},1214:(e,t,r)=>{"use strict";r.d(t,{PromptTemplate:()=>i});var a=r(1307),n=r(7327);class i extends a.A{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,n.af)(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return(0,n.SM)(this.template,this.templateFormat,t)}static fromExamples(e,t,r,a="\n\n",n=""){const s=[n,...e,t].join(a);return new i({inputVariables:r,template:s})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){const a=new Set;return(0,n.$M)(e,t).forEach((e=>{"variable"===e.type&&a.add(e.name)})),new i({inputVariables:[...a],templateFormat:t,template:e,...r})}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new i(a)}serialize(){if(void 0!==this.outputParser)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new i({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}},1307:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var a=r(1141),n=r(619);class i extends n.d{async formatPromptValue(e){const t=await this.format(e);return new a.nw(t)}}},7327:(e,t,r)=>{"use strict";r.d(t,{$M:()=>o,SM:()=>s,_O:()=>a,af:()=>l});const a=e=>{const t=e.split(""),r=[],a=(e,r)=>{for(let a=r;a<t.length;a+=1)if(e.includes(t[a]))return a;return-1};let n=0;for(;n<t.length;)if("{"===t[n]&&n+1<t.length&&"{"===t[n+1])r.push({type:"literal",text:"{"}),n+=2;else if("}"===t[n]&&n+1<t.length&&"}"===t[n+1])r.push({type:"literal",text:"}"}),n+=2;else if("{"===t[n]){const e=a("}",n);if(e<0)throw new Error("Unclosed '{' in template.");r.push({type:"variable",name:t.slice(n+1,e).join("")}),n=e+1}else{if("}"===t[n])throw new Error("Single '}' in template.");{const e=a("{}",n),i=(e<0?t.slice(n):t.slice(n,e)).join("");r.push({type:"literal",text:i}),n=e<0?t.length:e}}return r},n={"f-string":(e,t)=>a(e).reduce(((e,r)=>{if("variable"===r.type){if(r.name in t)return e+t[r.name];throw new Error(`Missing value for input ${r.name}`)}return e+r.text}),"")},i={"f-string":a},s=(e,t,r)=>n[t](e,r),o=(e,t)=>i[t](e),l=(e,t,r)=>{if(!(t in n)){const e=Object.keys(n);throw new Error(`Invalid template format. Got \`${t}\`;\n                         should be one of ${e}`)}try{const a=r.reduce(((e,t)=>(e[t]="foo",e)),{});Array.isArray(e)?e.forEach((e=>{if("text"===e.type)s(e.text,t,a);else{if("image_url"!==e.type)throw new Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`);if("string"==typeof e.image_url)s(e.image_url,t,a);else{const r=e.image_url.url;s(r,t,a)}}})):s(e,t,a)}catch(e){throw new Error(`Invalid prompt schema: ${e.message}`)}}},2608:(e,t,r)=>{"use strict";r.d(t,{eq:()=>v,lW:()=>P});var a=r(2693),n=r(238),i=r(344),s=r(4075),o=r(6076),l=r(3908);class c{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=(0,i.af)({},t);return new u({ops:t,state:r[r.length-1].newDocument})}}class u extends c{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=(0,i.af)(this.state,e.ops);return new u({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=(0,i.af)({},e.ops);return new u({ops:e.ops,state:t[t.length-1].newDocument})}}async function h(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||""!==r?.input?r.input:void 0}async function d(e,t){const{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&void 0!==r?.output?r.output:r}class p extends s.Z{constructor(e){super(e),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=o.QJ.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new c({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new c({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await h(e,this._schemaFormat)),await this.writer.write(new c({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await h(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await d(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new c({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new c({ops:[{op:"replace",path:"/final_output",value:await d(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(void 0===a)return;let n;var i;void 0!==e.inputs.messages?(i=r?.chunk,n=void 0!==i&&void 0!==i.message?r?.chunk:new l.GC(t)):n=t;const s=new c({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:n}]});await this.writer.write(s)}}var m=r(6141),f=r(7798),g=r(9636);class b extends s.Z{constructor({config:e,onStart:t,onEnd:r,onError:a}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}class y{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const a=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||a.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&a.every((e=>!this.excludeTags?.includes(e)))),r}}function w(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class v extends m.i{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new _({bound:this,kwargs:e,config:{}})}map(){return new O({bound:this})}withRetry(e){return new x({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new _({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new T({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map(f.LE)}return Array.from({length:t},(()=>(0,f.LE)(e)))}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=a[0]?.maxConcurrency??r?.maxConcurrency,i=new g.L({maxConcurrency:n,onFailedAttempt:e=>{throw e}}),s=e.map(((e,t)=>i.call((async()=>{try{return await this.invoke(e,a[t])}catch(e){if(r?.returnExceptions)return e;throw e}}))));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=new o.qq(this._streamIterator(e,t));return await r.setup,o.QJ.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e={}){const t=(0,f.LE)({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,[t,r]}async _callWithConfig(e,t,r){const a=(0,f.LE)(r),n=await(0,f.Le)(a),i=await(n?.handleChainStart(this.toJSON(),w(t,"input"),void 0,a?.runType,void 0,void 0,a?.runName??this.getName()));let s;try{s=await e.call(this,t,a,i)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(w(s,"output"))),s}async _batchWithConfig(e,t,r,a){const n=this._getOptionsList(r??{},t.length),i=await Promise.all(n.map(f.Le)),s=await Promise.all(i.map(((e,r)=>e?.handleChainStart(this.toJSON(),w(t[r],"input"),void 0,n[r].runType,void 0,void 0,n[r].runName??this.getName()))));let o;try{o=await e.call(this,t,n,s,a)}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(w(o,"output"))))),o}async*_transformStreamWithConfig(e,t,r){let a,n,i=!0,s=!0;const l=(0,f.LE)(r),c=await(0,f.Le)(l);let u;try{const r=await(0,o.E7)(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===a)a=t;else try{a=(0,o.zo)(a,t)}catch{a=void 0,i=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},void 0,l?.runType,void 0,void 0,l?.runName??this.getName())),l);u=r.setup;const h=e=>"log_stream_tracer"===e.name,d=u?.handlers.find(h);let p=r.output;void 0!==d&&void 0!==u&&(p=await d.tapOutputIterable(u.runId,r.output));for await(const e of p)if(yield e,s)if(void 0===n)n=e;else try{n=(0,o.zo)(n,e)}catch{n=void 0,s=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:w(a,"input")})),e}await(u?.handleChainEnd(n??{},void 0,void 0,void 0,{inputs:w(a,"input")}))}pipe(e){return new P({first:this,last:S(e)})}pick(e){return this.pipe(new C(e))}assign(e){return this.pipe(new j(new k({steps:e})))}async*transform(e,t){let r;for await(const t of e)r=void 0===r?t:(0,o.zo)(r,t);yield*this._streamIterator(r,t)}async*streamLog(e,t,r){const a=new p({...r,autoClose:!1,_schemaFormat:"original"}),n=(0,f.LE)(t);yield*this._streamLog(e,a,n)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(void 0===a)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const e=a.copy();e.inheritableHandlers.push(t),r.callbacks=e}const n=this.stream(e,r),i=async function(){try{const e=await n;for await(const r of e){const e=new c({ops:[{op:"add",path:"/streamed_output/-",value:r}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}async*streamEvents(e,t,r){if("v1"!==t.version)throw new Error('Only version "v1" of the events schema is currently supported.');let a,n=!1;const i=(0,f.LE)(t),s=i.tags??[],o=i.metadata??{},l=i.runName??this.getName(),c=new p({...r,autoClose:!1,_schemaFormat:"streaming_events"}),h=new y({...r}),d=this._streamLog(e,c,i);for await(const t of d){if(a=a?a.concat(t):u.fromRunLogPatch(t),void 0===a.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!n){n=!0;const t={...a.state},r={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:s,metadata:o,data:{input:e}};h.includeEvent(r,t.type)&&(yield r)}const r=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),i=[...new Set(r)];for(const e of i){let t,r={};const n=a.state.logs[e];if(t=void 0===n.end_time?n.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==n.inputs&&(r.input=n.inputs);else if("end"===t)void 0!==n.inputs&&(r.input=n.inputs),r.output=n.final_output;else if("stream"===t){const e=n.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${n.name}"`);r={chunk:n.streamed_output[0]},n.streamed_output=[]}yield{event:`on_${n.type}_${t}`,name:n.name,run_id:n.id,tags:n.tags,metadata:n.metadata,data:r}}const{state:c}=a;if(c.streamed_output.length>0){const e=c.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${c.name}"`);const t={chunk:c.streamed_output[0]};c.streamed_output=[];const r={event:`on_${c.type}_stream`,run_id:c.id,tags:s,metadata:o,name:l,data:t};h.includeEvent(r,c.type)&&(yield r)}}const m=a?.state;if(void 0!==m){const e={event:`on_${m.type}_end`,name:l,run_id:m.id,tags:s,metadata:o,data:{output:m.final_output}};h.includeEvent(e,m.type)&&(yield e)}}static isRunnable(e){return!!e&&e.lc_runnable}withListeners({onStart:e,onEnd:t,onError:r}){return new _({bound:this,config:{},configFactories:[a=>({callbacks:[new b({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class _ extends v{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=(0,f.t8)(this.config,...e);return(0,f.t8)(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(t,this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(e,this.kwargs)))):await this._mergeConfig(t,this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(t,this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(t,this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(t,this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig(t,this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&v.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new _({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new b({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class O extends v{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new O({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,(0,f.q)(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new O({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class x extends _{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return(0,f.q)(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return a((a=>super.invoke(e,this._patchConfigForRetry(a,t,r))),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,n){const i={};try{await a((async a=>{const s=e.map(((e,t)=>t)).filter((e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error)),o=s.map((t=>e[t])),l=s.map((e=>this._patchConfigForRetry(a,t?.[e],r?.[e]))),c=await super.batch(o,l,{...n,returnExceptions:!0});let u;for(let e=0;e<c.length;e+=1){const t=c[e],r=s[e];t instanceof Error&&void 0===u&&(u=t),i[r.toString()]=t}if(u)throw u;return c}),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==n?.returnExceptions)throw e}return Object.keys(i).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>i[parseInt(e,10)]))}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class P extends v{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=await(0,f.Le)(t),a=await(r?.handleChainStart(this.toJSON(),w(e,"input"),void 0,void 0,void 0,void 0,t?.runName));let n,i=e;try{const e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){const n=e[r];i=await n.invoke(i,(0,f.q)(t,{callbacks:a?.getChild(`seq:step:${r+1}`)}))}n=await this.last.invoke(i,(0,f.q)(t,{callbacks:a?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(w(n,"output"))),n}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=await Promise.all(a.map(f.Le)),i=await Promise.all(n.map(((t,r)=>t?.handleChainStart(this.toJSON(),w(e[r],"input"),void 0,void 0,void 0,void 0,a[r].runName))));let s=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];s=await t.batch(s,i.map(((t,r)=>{const n=t?.getChild(`seq:step:${e+1}`);return(0,f.q)(a[r],{callbacks:n})})),r)}}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(w(s,"output"))))),s}async*_streamIterator(e,t){const r=await(0,f.Le)(t),a=await(r?.handleChainStart(this.toJSON(),w(e,"input"),void 0,void 0,void 0,void 0,t?.runName)),n=[this.first,...this.middle,this.last];let i,s=!0;try{let r=n[0].transform(async function*(){yield e}(),(0,f.q)(t,{callbacks:a?.getChild("seq:step:1")}));for(let e=1;e<n.length;e+=1){const i=n[e];r=await i.transform(r,(0,f.q)(t,{callbacks:a?.getChild(`seq:step:${e+1}`)}))}for await(const e of r)if(yield e,s)if(void 0===i)i=e;else try{i=(0,o.zo)(i,e)}catch(e){i=void 0,s=!1}}catch(e){throw await(a?.handleChainError(e)),e}await(a?.handleChainEnd(w(i,"output")))}pipe(e){return P.isRunnableSequence(e)?new P({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new P({first:this.first,middle:[...this.middle,this.last],last:S(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&v.isRunnable(e)}static from([e,...t],r){return new P({first:S(e),middle:t.slice(0,-1).map(S),last:S(t[t.length-1]),name:r})}}class k extends v{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=S(r)}static from(e){return new k({steps:e})}async invoke(e,t){const r=await(0,f.Le)(t),a=await(r?.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,t?.runName)),n={};try{await Promise.all(Object.entries(this.steps).map((async([r,i])=>{n[r]=await i.invoke(e,(0,f.q)(t,{callbacks:a?.getChild(`map:key:${r}`)}))})))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(n)),n}async*_transform(e,t,r){const a={...this.steps},n=(0,o.y2)(e,Object.keys(a).length),i=new Map(Object.entries(a).map((([e,a],i)=>{const s=a.transform(n[i],(0,f.q)(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then((t=>({key:e,gen:s,result:t})))]})));for(;i.size;){const{key:e,result:t,gen:r}=await Promise.race(i.values());i.delete(e),t.done||(yield{[e]:t.value},i.set(e,r.next().then((t=>({key:e,gen:r,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new o.qq(this.transform(async function*(){yield e}(),t));return await r.setup,o.QJ.fromAsyncGenerator(r)}}class E extends v{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new E({func:e})}async _invoke(e,t,r){let a=await this.func(e,{...t,config:t});if(a&&v.isRunnable(a)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");a=await a.invoke(e,(0,f.q)(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??f.ov)-1}))}return a}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(const t of e)if(void 0===a)a=t;else try{a=(0,o.zo)(a,t)}catch(e){a=t}const n=await this.func(a,{...r,config:r});if(n&&v.isRunnable(n)){if(0===r?.recursionLimit)throw new Error("Recursion limit reached.");const e=await n.stream(a,(0,f.q)(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??f.ov)-1}));for await(const t of e)yield t}else yield n}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new o.qq(this.transform(async function*(){yield e}(),t));return await r.setup,o.QJ.fromAsyncGenerator(r)}}class T extends v{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await n.Ye.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),a=await(r?.handleChainStart(this.toJSON(),w(e,"input"),void 0,void 0,void 0,void 0,t?.runName));let i;for(const r of this.runnables())try{const n=await r.invoke(e,(0,f.q)(t,{callbacks:a?.getChild()}));return await(a?.handleChainEnd(w(n,"output"))),n}catch(e){void 0===i&&(i=e)}if(void 0===i)throw new Error("No error stored at end of fallback.");throw await(a?.handleChainError(i)),i}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),i=await Promise.all(a.map((e=>n.Ye.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)))),s=await Promise.all(i.map(((t,r)=>t?.handleChainStart(this.toJSON(),w(e[r],"input"),void 0,void 0,void 0,void 0,a[r].runName))));let o;for(const t of this.runnables())try{const n=await t.batch(e,s.map(((e,t)=>(0,f.q)(a[t],{callbacks:e?.getChild()}))),r);return await Promise.all(s.map(((e,t)=>e?.handleChainEnd(w(n[t],"output"))))),n}catch(e){void 0===o&&(o=e)}if(!o)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map((e=>e?.handleChainError(o)))),o}}function S(e){if("function"==typeof e)return new E({func:e});if(v.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[r,a]of Object.entries(e))t[r]=S(a);return new k({steps:t})}}class j extends v{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof k&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[n,i]=(0,o.y2)(e),s=this.mapper.transform(i,(0,f.q)(r,{callbacks:t?.getChild()})),l=s.next();for await(const e of n){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!a.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await l).value;for await(const e of s)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new o.qq(this.transform(async function*(){yield e}(),t));return await r.setup,o.QJ.fromAsyncGenerator(r)}}class C extends v{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new o.qq(this.transform(async function*(){yield e}(),t));return await r.setup,o.QJ.fromAsyncGenerator(r)}}},7798:(e,t,r)=>{"use strict";r.d(t,{LE:()=>l,Le:()=>i,ov:()=>n,q:()=>c,t8:()=>s});var a=r(238);const n=25;async function i(e){return a.Ye.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function s(...e){const t=l();for(const r of e.filter((e=>!!e)))for(const e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e)t[e]=[...new Set(t[e].concat(r[e]??[]))];else if("configurable"===e)t[e]={...t[e],...r[e]};else if("callbacks"===e){const e=t.callbacks,n=r.callbacks;if(Array.isArray(n))if(e)if(Array.isArray(e))t.callbacks=e.concat(n);else{const r=e.copy();for(const e of n)r.addHandler((0,a.xz)(e),!0);t.callbacks=r}else t.callbacks=n;else if(n)if(e)if(Array.isArray(e)){const r=n.copy();for(const t of e)r.addHandler((0,a.xz)(t),!0);t.callbacks=r}else t.callbacks=new a.Ye(n._parentRunId,{handlers:e.handlers.concat(n.handlers),inheritableHandlers:e.inheritableHandlers.concat(n.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(n.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(n.inheritableTags))),metadata:{...e.metadata,...n.metadata}});else t.callbacks=n}else{const a=e;t[a]=r[a]??t[a]}return t}const o=new Set(["string","number","boolean"]);function l(e){let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(e&&(t={...t,...e}),e?.configurable)for(const r of Object.keys(e.configurable))o.has(typeof e.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=e.configurable[r]);return t}function c(e={},{callbacks:t,maxConcurrency:r,recursionLimit:a,runName:n,configurable:i}={}){const s=l(e);return void 0!==t&&(delete s.runName,s.callbacks=t),void 0!==a&&(s.recursionLimit=a),void 0!==r&&(s.maxConcurrency=r),void 0!==n&&(s.runName=n),void 0!==i&&(s.configurable={...s.configurable,...i}),s}},4075:(e,t,r)=>{"use strict";r.d(t,{Z:()=>i});var a=r(6515);function n(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class i extends a.E{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=(r=e.start_time,a=e.id,`${new Date(r).toISOString().slice(0,-1)}000Z`.replace(/[-:.]/g,"")+a);var r,a;const n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;this.runMap.set(n.id,n),await(this.onRunCreate?.(n))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,n,i,s,o){const l=this._getExecutionOrder(a),c=Date.now(),u=s?{...n,metadata:s}:n,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleChatModelStart(e,t,r,a,n,i,s,o){const l=this._getExecutionOrder(a),c=Date.now(),u=s?{...n,metadata:s}:n,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleLLMEnd(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onLLMEnd?.(r)),await this._endTrace(r),r}async handleLLMError(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onLLMError?.(r)),await this._endTrace(r),r}async handleChainStart(e,t,r,a,n,i,s,o){const l=this._getExecutionOrder(a),c=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(u),await(this.onChainStart?.(u)),u}async handleChainEnd(e,t,r,a,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=n(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=n(i.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,r,a,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=n(i.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}async handleToolStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(c),await(this.onToolStart?.(c)),c}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||"chain"!==r?.run_type)return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}async handleRetrieverStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(c),await(this.onRetrieverStart?.(c)),c}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,a,n,i){const s=this.runMap.get(r);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}},7759:(e,t,r)=>{"use strict";r.d(t,{Z:()=>c});var a=r(265),n=r(4075);function i(e,t){return`${e.open}${t}${e.close}`}function s(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function o(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:l}=a;class c extends n.Z{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,r)=>{const n=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?i(a.bold,n):n})).join(" > ");return i(l.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.green,"[chain/start]")} [${t}] Entering Chain run with input: ${s(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[chain/end]")} [${t}] [${o(e)}] Exiting Chain run with output: ${s(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[chain/error]")} [${t}] [${o(e)}] Chain run errored with error: ${s(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${i(l.green,"[llm/start]")} [${t}] Entering LLM run with input: ${s(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[llm/end]")} [${t}] [${o(e)}] Exiting LLM run with output: ${s(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[llm/error]")} [${t}] [${o(e)}] LLM run errored with error: ${s(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[tool/end]")} [${t}] [${o(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[tool/error]")} [${t}] [${o(e)}] Tool run errored with error: ${s(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${s(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[retriever/end]")} [${t}] [${o(e)}] Exiting Retriever run with output: ${s(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[retriever/error]")} [${t}] [${o(e)}] Retriever run errored with error: ${s(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${i(l.blue,"[agent/action]")} [${r}] Agent selected action: ${s(t.actions[t.actions.length-1],"[action]")}`)}}},9636:(e,t,r)=>{"use strict";r.d(t,{L:()=>o});var a=r(2693),n=r(5860);const i=[400,401,402,403,404,405,406,407,408,409],s=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||"TimeoutError"===e.name||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&i.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class o{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??s;const t=n.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>a((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}},344:(e,t,r)=>{"use strict";r.d(t,{af:()=>b});var a={};r.r(a),r.d(a,{JsonPatchError:()=>h,_areEquals:()=>_,applyOperation:()=>g,applyPatch:()=>b,applyReducer:()=>y,deepClone:()=>d,getValueByPointer:()=>f,validate:()=>v,validator:()=>w});const n=Object.prototype.hasOwnProperty;function i(e,t){return n.call(e,t)}function s(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function o(e){let t=0;const r=e.length;let a;for(;t<r;){if(a=e.charCodeAt(t),!(a>=48&&a<=57))return!1;t++}return!0}function l(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(l(e[t]))return!0}else if("object"==typeof e){const r=function(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)i(e,r)&&t.push(r);return t}(e),a=r.length;for(var t=0;t<a;t++)if(l(e[r[t]]))return!0}return!1}function c(e,t){const r=[e];for(const e in t){const a="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==a&&r.push(`${e}: ${a}`)}return r.join("\n")}class u extends Error{constructor(e,t,r,a,n){super(c(e,{name:t,index:r,operation:a,tree:n})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.setPrototypeOf(this,new.target.prototype),this.message=c(e,{name:t,index:r,operation:a,tree:n})}}const h=u,d=s,p={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var a=e[t];return delete e[t],{newDocument:r,removed:a}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:function(e,t,r){let a=f(r,this.path);a&&(a=s(a));const n=g(r,{op:"remove",path:this.from}).removed;return g(r,{op:"add",path:this.path,value:n}),{newDocument:r,removed:a}},copy:function(e,t,r){const a=f(r,this.from);return g(r,{op:"add",path:this.path,value:s(a)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:_(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var m={add:function(e,t,r){return o(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:p.move,copy:p.copy,test:p.test,_get:p._get};function f(e,t){if(""==t)return e;var r={op:"_get",path:t};return g(e,r),r.value}function g(e,t,r=!1,a=!0,n=!0,i=0){if(r&&("function"==typeof r?r(t,0,e,t.path):w(t,0)),""===t.path){let a={newDocument:e};if("add"===t.op)return a.newDocument=t.value,a;if("replace"===t.op)return a.newDocument=t.value,a.removed=e,a;if("move"===t.op||"copy"===t.op)return a.newDocument=f(e,t.from),"move"===t.op&&(a.removed=e),a;if("test"===t.op){if(a.test=_(e,t.value),!1===a.test)throw new h("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a.newDocument=e,a}if("remove"===t.op)return a.removed=e,a.newDocument=null,a;if("_get"===t.op)return t.value=e,a;if(r)throw new h("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return a}{a||(e=s(e));const l=(t.path||"").split("/");let c,u,d,f=e,g=1,b=l.length;for(d="function"==typeof r?r:w;;){if(u=l[g],u&&-1!=u.indexOf("~")&&(u=u.replace(/~1/g,"/").replace(/~0/g,"~")),n&&("__proto__"==u||"prototype"==u&&g>0&&"constructor"==l[g-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===c&&(void 0===f[u]?c=l.slice(0,g).join("/"):g==b-1&&(c=t.path),void 0!==c&&d(t,0,e,c)),g++,Array.isArray(f)){if("-"===u)u=f.length;else{if(r&&!o(u))throw new h("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);o(u)&&(u=~~u)}if(g>=b){if(r&&"add"===t.op&&u>f.length)throw new h("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const a=m[t.op].call(t,f,u,e);if(!1===a.test)throw new h("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a}}else if(g>=b){const r=p[t.op].call(t,f,u,e);if(!1===r.test)throw new h("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}if(f=f[u],r&&g<b&&(!f||"object"!=typeof f))throw new h("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function b(e,t,r,a=!0,n=!0){if(r&&!Array.isArray(t))throw new h("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");a||(e=s(e));const i=new Array(t.length);for(let a=0,s=t.length;a<s;a++)i[a]=g(e,t[a],r,!0,n,a),e=i[a].newDocument;return i.newDocument=e,i}function y(e,t,r){const a=g(e,t);if(!1===a.test)throw new h("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return a.newDocument}function w(e,t,r,a){if("object"!=typeof e||null===e||Array.isArray(e))throw new h("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!p[e.op])throw new h("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new h("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new h('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new h("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new h("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&l(e.value))throw new h("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var n=e.path.split("/").length,i=a.split("/").length;if(n!==i+1&&n!==i)throw new h("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==a)throw new h("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=v([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new h("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function v(e,t,r){try{if(!Array.isArray(e))throw new h("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)b(s(t),s(e),r||!0);else{r=r||w;for(var a=0;a<e.length;a++)r(e[a],a,t,void 0)}}catch(e){if(e instanceof h)return e;throw e}}function _(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,a,n,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((a=e.length)!=t.length)return!1;for(r=a;0!=r--;)if(!_(e[r],t[r]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((a=o.length)!==Object.keys(t).length)return!1;for(r=a;0!=r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=a;0!=r--;)if(!_(e[n=o[r]],t[n]))return!1;return!0}return e!=e&&t!=t}new WeakMap},6076:(e,t,r)=>{"use strict";r.d(t,{E7:()=>o,QJ:()=>a,qq:()=>s,y2:()=>n,zo:()=>i});class a extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new a({start:e=>function r(){return t.read().then((({done:t,value:a})=>{if(!t)return e.enqueue(a),r();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new a({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function n(e,t=2){const r=Array.from({length:t},(()=>[]));return r.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function i(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const r={...e};for(const[e,a]of Object.entries(t))e in r&&!Array.isArray(r[e])?r[e]=i(r[e],a):r[e]=a;return r}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class s{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise(((r,a)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,a):this.firstResult.then((e=>r(void 0)),a)}))}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function o(e,t,r,...a){const n=new s(t,r),i=await n.setup;return{output:e(n,i,...a),setup:i}}}},t={};function r(a){var n=t[a];if(void 0!==n)return n.exports;var i=t[a]={id:a,loaded:!1,exports:{}};return e[a](i,i.exports,r),i.loaded=!0,i.exports}r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{"use strict";class e{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent?e.pageContent.toString():this.pageContent,this.metadata=e.metadata??{}}}var t=r(2608);class a extends t.eq{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","documents","transformers"]})}invoke(e,t){return this.transformDocuments(e)}}var n=r(3908),i=r(7798),s=r(6076);class o extends t.eq{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async e=>this.parseResult([{text:e}])),e,{...t,runType:"parser"}):this._callWithConfig((async e=>this.parseResult([{message:e,text:"string"==typeof e.content?e.content:JSON.stringify(e.content)}])),e,{...t,runType:"parser"})}}class l extends o{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}"undefined"!=typeof self&&self.location&&"null"!==self.location.origin&&(self.location.origin,self.location.pathname,location.search);class c extends l{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:"string"==typeof t.content?t.content:JSON.stringify(t.content)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class u extends c{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}}r(344),r(619);var h=r(9242);r(7315),r(1214),r(1307),r(7327),r(6428);var d=r(7759),p=r(9742),m=Object.defineProperty;function f(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let r=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;r.length>1;){let a=null;for(let n=0;n<r.length-1;n++){const i=e.slice(r[n].start,r[n+1].end),s=t.get(i.join(","));null!=s&&(null==a||s<a[0])&&(a=[s,n])}if(null==a)break;{const e=a[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}}return r}(e,t).map((r=>t.get(e.slice(r.start,r.end).join(",")))).filter((e=>null!=e))}var g,b=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const r=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[r,a,...n]=t.split(" "),i=Number.parseInt(a,10);return n.forEach(((t,r)=>e[t]=i+r)),e}),{});for(const[e,t]of Object.entries(r)){const r=p.toByteArray(e);this.rankMap.set(r.join(","),t),this.textMap.set(t,r)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],r="all"){const a=new RegExp(this.patStr,"ug"),n=b.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter((e=>!s.has(e))):r);if(o.size>0){const t=b.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw new Error(`The text contains a special token that is not allowed: ${r[0]}`)}let l=0;for(;;){let t=null,r=l;for(;n.lastIndex=r,t=n.exec(e),null!=t&&!s.has(t[0]);)r=t.index+1;const o=t?.index??e.length;for(const t of e.substring(l,o).matchAll(a)){const e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));null==r?i.push(...f(e,this.rankMap)):i.push(r)}if(null==t)break;let c=this.specialTokens[t[0]];i.push(c),l=t.index+t[0].length}return i}decode(e){const t=[];let r=0;for(let a=0;a<e.length;++a){const n=e[a],i=this.textMap.get(n)??this.inverseSpecialTokens[n];null!=i&&(t.push(i),r+=i.length)}const a=new Uint8Array(r);let n=0;for(const e of t)a.set(e,n),n+=e.length;return this.textDecoder.decode(a)}},y=b;((e,t,r)=>{t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(y,"symbol"!=typeof(g="specialTokenRegex")?g+"":g,(e=>new RegExp(e.map((e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&"))).join("|"),"g")));var w=r(9636);const v={},_=new w.L({});class O extends a{constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","document_transformers","text_splitters"]}),Object.defineProperty(this,"chunkSize",{enumerable:!0,configurable:!0,writable:!0,value:1e3}),Object.defineProperty(this,"chunkOverlap",{enumerable:!0,configurable:!0,writable:!0,value:200}),Object.defineProperty(this,"keepSeparator",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lengthFunction",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chunkSize=e?.chunkSize??this.chunkSize,this.chunkOverlap=e?.chunkOverlap??this.chunkOverlap,this.keepSeparator=e?.keepSeparator??this.keepSeparator,this.lengthFunction=e?.lengthFunction??(e=>e.length),this.chunkOverlap>=this.chunkSize)throw new Error("Cannot have chunkOverlap >= chunkSize")}async transformDocuments(e,t={}){return this.splitDocuments(e,t)}splitOnSeparator(e,t){let r;if(t)if(this.keepSeparator){const a=t.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");r=e.split(new RegExp(`(?=${a})`))}else r=e.split(t);else r=e.split("");return r.filter((e=>""!==e))}async createDocuments(t,r=[],a={}){const n=r.length>0?r:[...Array(t.length)].map((()=>({}))),{chunkHeader:i="",chunkOverlapHeader:s="(cont'd) ",appendChunkOverlapHeader:o=!1}=a,l=new Array;for(let r=0;r<t.length;r+=1){const a=t[r];let c=1,u=null,h=-1;for(const t of await this.splitText(a)){let d=i;const p=a.indexOf(t,h+1);if(null===u)c+=this.numberOfNewLines(a,0,p);else{const e=h+await this.lengthFunction(u);e<p?c+=this.numberOfNewLines(a,e,p):e>p&&(c-=this.numberOfNewLines(a,p,e)),o&&(d+=s)}const m=this.numberOfNewLines(t),f=n[r].loc&&"object"==typeof n[r].loc?{...n[r].loc}:{};f.lines={from:c,to:c+m};const g={...n[r],loc:f};d+=t,l.push(new e({pageContent:d,metadata:g})),c+=m,u=t,h=p}}return l}numberOfNewLines(e,t,r){return(e.slice(t,r).match(/\n/g)||[]).length}async splitDocuments(e,t={}){const r=e.filter((e=>void 0!==e.pageContent)),a=r.map((e=>e.pageContent)),n=r.map((e=>e.metadata));return this.createDocuments(a,n,t)}joinDocs(e,t){const r=e.join(t).trim();return""===r?null:r}async mergeSplits(e,t){const r=[],a=[];let n=0;for(const i of e){const e=await this.lengthFunction(i);if(n+e+(a.length>0?t.length:0)>this.chunkSize&&(n>this.chunkSize&&console.warn(`Created a chunk of size ${n}, +\nwhich is longer than the specified ${this.chunkSize}`),a.length>0)){const i=this.joinDocs(a,t);for(null!==i&&r.push(i);n>this.chunkOverlap||n+e>this.chunkSize&&n>0;)n-=await this.lengthFunction(a[0]),a.shift()}a.push(i),n+=e}const i=this.joinDocs(a,t);return null!==i&&r.push(i),r}}class x extends O{static lc_name(){return"RecursiveCharacterTextSplitter"}constructor(e){super(e),Object.defineProperty(this,"separators",{enumerable:!0,configurable:!0,writable:!0,value:["\n\n","\n"," ",""]}),this.separators=e?.separators??this.separators,this.keepSeparator=e?.keepSeparator??!0}async _splitText(e,t){const r=[];let a,n=t[t.length-1];for(let r=0;r<t.length;r+=1){const i=t[r];if(""===i){n=i;break}if(e.includes(i)){n=i,a=t.slice(r+1);break}}const i=this.splitOnSeparator(e,n);let s=[];const o=this.keepSeparator?"":n;for(const e of i)if(await this.lengthFunction(e)<this.chunkSize)s.push(e);else{if(s.length){const e=await this.mergeSplits(s,o);r.push(...e),s=[]}if(a){const t=await this._splitText(e,a);r.push(...t)}else r.push(e)}if(s.length){const e=await this.mergeSplits(s,o);r.push(...e)}return r}async splitText(e){return this._splitText(e,this.separators)}static fromLanguage(e,t){return new x({...t,separators:x.getSeparatorsForLanguage(e)})}static getSeparatorsForLanguage(e){if("cpp"===e)return["\nclass ","\nvoid ","\nint ","\nfloat ","\ndouble ","\nif ","\nfor ","\nwhile ","\nswitch ","\ncase ","\n\n","\n"," ",""];if("go"===e)return["\nfunc ","\nvar ","\nconst ","\ntype ","\nif ","\nfor ","\nswitch ","\ncase ","\n\n","\n"," ",""];if("java"===e)return["\nclass ","\npublic ","\nprotected ","\nprivate ","\nstatic ","\nif ","\nfor ","\nwhile ","\nswitch ","\ncase ","\n\n","\n"," ",""];if("js"===e)return["\nfunction ","\nconst ","\nlet ","\nvar ","\nclass ","\nif ","\nfor ","\nwhile ","\nswitch ","\ncase ","\ndefault ","\n\n","\n"," ",""];if("php"===e)return["\nfunction ","\nclass ","\nif ","\nforeach ","\nwhile ","\ndo ","\nswitch ","\ncase ","\n\n","\n"," ",""];if("proto"===e)return["\nmessage ","\nservice ","\nenum ","\noption ","\nimport ","\nsyntax ","\n\n","\n"," ",""];if("python"===e)return["\nclass ","\ndef ","\n\tdef ","\n\n","\n"," ",""];if("rst"===e)return["\n===\n","\n---\n","\n***\n","\n.. ","\n\n","\n"," ",""];if("ruby"===e)return["\ndef ","\nclass ","\nif ","\nunless ","\nwhile ","\nfor ","\ndo ","\nbegin ","\nrescue ","\n\n","\n"," ",""];if("rust"===e)return["\nfn ","\nconst ","\nlet ","\nif ","\nwhile ","\nfor ","\nloop ","\nmatch ","\nconst ","\n\n","\n"," ",""];if("scala"===e)return["\nclass ","\nobject ","\ndef ","\nval ","\nvar ","\nif ","\nfor ","\nwhile ","\nmatch ","\ncase ","\n\n","\n"," ",""];if("swift"===e)return["\nfunc ","\nclass ","\nstruct ","\nenum ","\nif ","\nfor ","\nwhile ","\ndo ","\nswitch ","\ncase ","\n\n","\n"," ",""];if("markdown"===e)return["\n## ","\n### ","\n#### ","\n##### ","\n###### ","```\n\n","\n\n***\n\n","\n\n---\n\n","\n\n___\n\n","\n\n","\n"," ",""];if("latex"===e)return["\n\\chapter{","\n\\section{","\n\\subsection{","\n\\subsubsection{","\n\\begin{enumerate}","\n\\begin{itemize}","\n\\begin{description}","\n\\begin{list}","\n\\begin{quote}","\n\\begin{quotation}","\n\\begin{verse}","\n\\begin{verbatim}","\n\\begin{align}","$$","$","\n\n","\n"," ",""];if("html"===e)return["<body>","<div>","<p>","<br>","<li>","<h1>","<h2>","<h3>","<h4>","<h5>","<h6>","<span>","<table>","<tr>","<td>","<th>","<ul>","<ol>","<header>","<footer>","<nav>","<head>","<style>","<script>","<meta>","<title>"," ",""];if("sol"===e)return["\npragma ","\nusing ","\ncontract ","\ninterface ","\nlibrary ","\nconstructor ","\ntype ","\nfunction ","\nevent ","\nmodifier ","\nerror ","\nstruct ","\nenum ","\nif ","\nfor ","\nwhile ","\ndo while ","\nassembly ","\n\n","\n"," ",""];throw new Error(`Language ${e} is not supported.`)}}const P=e=>e.map((e=>e.pageContent)).join("\n\n"),k="__run";class E{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new E({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class T extends E{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new T({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}var S="object"==typeof window?window:{},j="0123456789abcdef".split(""),C=[-2147483648,8388608,32768,128],A=[24,16,8,0],I=[];function M(e){e?(I[0]=I[16]=I[1]=I[2]=I[3]=I[4]=I[5]=I[6]=I[7]=I[8]=I[9]=I[10]=I[11]=I[12]=I[13]=I[14]=I[15]=0,this.blocks=I):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}M.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===S.ArrayBuffer&&(e=new Uint8Array(e));for(var r,a,n=0,i=e.length||0,s=this.blocks;n<i;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(a=this.start;n<i&&a<64;++n)s[a>>2]|=e[n]<<A[3&a++];else for(a=this.start;n<i&&a<64;++n)(r=e.charCodeAt(n))<128?s[a>>2]|=r<<A[3&a++]:r<2048?(s[a>>2]|=(192|r>>6)<<A[3&a++],s[a>>2]|=(128|63&r)<<A[3&a++]):r<55296||r>=57344?(s[a>>2]|=(224|r>>12)<<A[3&a++],s[a>>2]|=(128|r>>6&63)<<A[3&a++],s[a>>2]|=(128|63&r)<<A[3&a++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++n)),s[a>>2]|=(240|r>>18)<<A[3&a++],s[a>>2]|=(128|r>>12&63)<<A[3&a++],s[a>>2]|=(128|r>>6&63)<<A[3&a++],s[a>>2]|=(128|63&r)<<A[3&a++]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=s[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},M.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=C[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},M.prototype.hash=function(){var e,t,r=this.h0,a=this.h1,n=this.h2,i=this.h3,s=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)r=(t=(a=(t=(n=(t=(i=(t=(s=(t=r<<5|r>>>27)+(a&n|~a&i)+s+1518500249+o[e]<<0)<<5|s>>>27)+(r&(a=a<<30|a>>>2)|~r&n)+i+1518500249+o[e+1]<<0)<<5|i>>>27)+(s&(r=r<<30|r>>>2)|~s&a)+n+1518500249+o[e+2]<<0)<<5|n>>>27)+(i&(s=s<<30|s>>>2)|~i&r)+a+1518500249+o[e+3]<<0)<<5|a>>>27)+(n&(i=i<<30|i>>>2)|~n&s)+r+1518500249+o[e+4]<<0,n=n<<30|n>>>2;for(;e<40;e+=5)r=(t=(a=(t=(n=(t=(i=(t=(s=(t=r<<5|r>>>27)+(a^n^i)+s+1859775393+o[e]<<0)<<5|s>>>27)+(r^(a=a<<30|a>>>2)^n)+i+1859775393+o[e+1]<<0)<<5|i>>>27)+(s^(r=r<<30|r>>>2)^a)+n+1859775393+o[e+2]<<0)<<5|n>>>27)+(i^(s=s<<30|s>>>2)^r)+a+1859775393+o[e+3]<<0)<<5|a>>>27)+(n^(i=i<<30|i>>>2)^s)+r+1859775393+o[e+4]<<0,n=n<<30|n>>>2;for(;e<60;e+=5)r=(t=(a=(t=(n=(t=(i=(t=(s=(t=r<<5|r>>>27)+(a&n|a&i|n&i)+s-1894007588+o[e]<<0)<<5|s>>>27)+(r&(a=a<<30|a>>>2)|r&n|a&n)+i-1894007588+o[e+1]<<0)<<5|i>>>27)+(s&(r=r<<30|r>>>2)|s&a|r&a)+n-1894007588+o[e+2]<<0)<<5|n>>>27)+(i&(s=s<<30|s>>>2)|i&r|s&r)+a-1894007588+o[e+3]<<0)<<5|a>>>27)+(n&(i=i<<30|i>>>2)|n&s|i&s)+r-1894007588+o[e+4]<<0,n=n<<30|n>>>2;for(;e<80;e+=5)r=(t=(a=(t=(n=(t=(i=(t=(s=(t=r<<5|r>>>27)+(a^n^i)+s-899497514+o[e]<<0)<<5|s>>>27)+(r^(a=a<<30|a>>>2)^n)+i-899497514+o[e+1]<<0)<<5|i>>>27)+(s^(r=r<<30|r>>>2)^a)+n-899497514+o[e+2]<<0)<<5|n>>>27)+(i^(s=s<<30|s>>>2)^r)+a-899497514+o[e+3]<<0)<<5|a>>>27)+(n^(i=i<<30|i>>>2)^s)+r-899497514+o[e+4]<<0,n=n<<30|n>>>2;this.h0=this.h0+r<<0,this.h1=this.h1+a<<0,this.h2=this.h2+n<<0,this.h3=this.h3+i<<0,this.h4=this.h4+s<<0},M.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,n=this.h4;return j[e>>28&15]+j[e>>24&15]+j[e>>20&15]+j[e>>16&15]+j[e>>12&15]+j[e>>8&15]+j[e>>4&15]+j[15&e]+j[t>>28&15]+j[t>>24&15]+j[t>>20&15]+j[t>>16&15]+j[t>>12&15]+j[t>>8&15]+j[t>>4&15]+j[15&t]+j[r>>28&15]+j[r>>24&15]+j[r>>20&15]+j[r>>16&15]+j[r>>12&15]+j[r>>8&15]+j[r>>4&15]+j[15&r]+j[a>>28&15]+j[a>>24&15]+j[a>>20&15]+j[a>>16&15]+j[a>>12&15]+j[a>>8&15]+j[a>>4&15]+j[15&a]+j[n>>28&15]+j[n>>24&15]+j[n>>20&15]+j[n>>16&15]+j[n>>12&15]+j[n>>8&15]+j[n>>4&15]+j[15&n]},M.prototype.toString=M.prototype.hex,M.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,n=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,a>>24&255,a>>16&255,a>>8&255,255&a,n>>24&255,n>>16&255,n>>8&255,255&n]},M.prototype.array=M.prototype.digest,M.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const R=(...e)=>{return t=e.join("_"),new M(!0).update(t).hex();var t};class N{}const $=new Map;class L extends N{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(R(e,t))??null)}async update(e,t,r){this.cache.set(R(e,t),r)}static global(){return new L($)}}var U=r(1141);class D extends t.eq{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class F extends D{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof r.cache?this.cache=r.cache:r.cache?this.cache=L.global():this.cache=void 0,this.caller=new w.L(r??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in v||(v[e]=_.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new y(e))).catch((t=>{throw delete v[e],t}))),await v[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(r=this.modelName,r.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":r.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":r.startsWith("gpt-4-32k")?"gpt-4-32k":r.startsWith("gpt-4-")?"gpt-4":r):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var r;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new U.nw(e):Array.isArray(e)?new U.GU(e.map(n.E1)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){const t={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()},r=Object.entries(t).filter((([e,t])=>void 0!==t)).map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return r}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}var B=r(238);class z extends F{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r?.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){const r=z._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===z.prototype._streamResponseChunks)yield this.invoke(e,t);else{const r=z._convertInputToPromptValue(e).toChatMessages(),[a,n]=this._separateRunnableConfigFromCallOptions(t),i=await B.Ye.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),s={options:n,invocation_params:this?.invocationParams(n),batch_size:1},o=await(i?.handleChatModelStart(this.toJSON(),[r],void 0,void 0,s,void 0,void 0,a.runName));let l;try{for await(const e of this._streamResponseChunks(r,n,o?.[0]))yield e.message,l=l?l.concat(e):e}catch(e){throw await Promise.all((o??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((o??[]).map((e=>e?.handleLLMEnd({generations:[[l]]}))))}}async _generateUncached(e,t,r){const a=e.map((e=>e.map(n.E1))),i=await B.Ye.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1},o=await(i?.handleChatModelStart(this.toJSON(),a,void 0,void 0,s,void 0,void 0,r.runName)),l=await Promise.allSettled(a.map(((e,r)=>this._generate(e,{...t,promptIndex:r},o?.[r])))),c=[],u=[];await Promise.all(l.map((async(e,t)=>{if("fulfilled"===e.status){const r=e.value;return c[t]=r.generations,u[t]=r.llmOutput,o?.[t]?.handleLLMEnd({generations:[r.generations],llmOutput:r.llmOutput})}return await(o?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const h={generations:c,llmOutput:u.length?this._combineLLMOutput?.(...u):void 0};return Object.defineProperty(h,k,{value:o?{runIds:o?.map((e=>e.runId))}:void 0,configurable:!0}),h}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:i}){const s=e.map((e=>e.map(n.E1))),o=await B.Ye.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1,cached:!0},c=await(o?.handleChatModelStart(this.toJSON(),s,void 0,void 0,l,void 0,void 0,i.runName)),u=[],h=(await Promise.allSettled(s.map((async(e,a)=>{const n=z._convertInputToPromptValue(e).toString(),i=await t.lookup(n,r);return null==i&&u.push(a),i})))).map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),d=[];await Promise.all(h.map((async({result:e,runManager:t},r)=>{if("fulfilled"===e.status){const a=e.value;return d[r]=a,a.length&&await(t?.handleLLMNewToken(a[0].text)),t?.handleLLMEnd({generations:[a]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const p={generations:d,missingPromptIndices:u};return Object.defineProperty(p,k,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),p}async generate(e,t,r){let a;a=Array.isArray(t)?{stop:t}:t;const i=e.map((e=>e.map(n.E1))),[s,o]=this._separateRunnableConfigFromCallOptions(a);if(s.callbacks=s.callbacks??r,!this.cache)return this._generateUncached(i,o,s);const{cache:l}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:h}=await this._generateCached({messages:i,cache:l,llmStringKey:c,parsedOptions:o,handledOptions:s});let d={};if(h.length>0){const e=await this._generateUncached(h.map((e=>i[e])),o,s);await Promise.all(e.generations.map((async(e,t)=>{const r=h[t];u[r]=e;const a=z._convertInputToPromptValue(i[r]).toString();return l.update(a,c,e)}))),d=e.llmOutput??{}}return{generations:u,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const a=e.map((e=>e.toChatMessages()));return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(n.E1)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const a=new n.xk(e),i=await this.call([a],t,r);if("string"!=typeof i.content)throw new Error("Cannot use predict when output is not a string.");return i.content}}class q extends z{async _generate(e,t,r){const a=await this._call(e,t,r),i=new n.gY(a);if("string"!=typeof i.content)throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:i.content,message:i}]}}}async function*V(e,t,r){let a=e;a.startsWith("http://localhost:")&&(a=a.replace("http://localhost:","http://127.0.0.1:"));const n=await fetch(a,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",...r.headers},signal:r.signal});if(!n.ok){let e;const t=await n.text();try{const r=JSON.parse(t);e=new Error(`Ollama call failed with status code ${n.status}: ${r.error}`)}catch(r){e=new Error(`Ollama call failed with status code ${n.status}: ${t}`)}throw e.response=n,e}if(!n.body)throw new Error("Could not begin Ollama stream. Please check the given URL and try again.");const i=s.QJ.fromReadableStream(n.body),o=new TextDecoder;let l="";for await(const e of i){const t=(l+o.decode(e)).split("\n");l=t.pop()||"";for(const e of t)try{yield JSON.parse(e)}catch(t){console.warn(`Received a non-JSON parseable chunk: ${e}`)}}}class H extends q{static lc_name(){return"ChatOllama"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama2"}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://localhost:11434"}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:"5m"}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16KV",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGqa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyBase",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyScale",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMLock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMMap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model??this.model,this.baseUrl=e.baseUrl?.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl??this.baseUrl,this.keepAlive=e.keepAlive??this.keepAlive,this.embeddingOnly=e.embeddingOnly,this.f16KV=e.f16KV,this.frequencyPenalty=e.frequencyPenalty,this.headers=e.headers,this.logitsAll=e.logitsAll,this.lowVram=e.lowVram,this.mainGpu=e.mainGpu,this.mirostat=e.mirostat,this.mirostatEta=e.mirostatEta,this.mirostatTau=e.mirostatTau,this.numBatch=e.numBatch,this.numCtx=e.numCtx,this.numGpu=e.numGpu,this.numGqa=e.numGqa,this.numKeep=e.numKeep,this.numPredict=e.numPredict,this.numThread=e.numThread,this.penalizeNewline=e.penalizeNewline,this.presencePenalty=e.presencePenalty,this.repeatLastN=e.repeatLastN,this.repeatPenalty=e.repeatPenalty,this.ropeFrequencyBase=e.ropeFrequencyBase,this.ropeFrequencyScale=e.ropeFrequencyScale,this.temperature=e.temperature,this.stop=e.stop,this.tfsZ=e.tfsZ,this.topK=e.topK,this.topP=e.topP,this.typicalP=e.typicalP,this.useMLock=e.useMLock,this.useMMap=e.useMMap,this.vocabOnly=e.vocabOnly,this.format=e.format}_llmType(){return"ollama"}invocationParams(e){return{model:this.model,format:this.format,keep_alive:this.keepAlive,options:{embedding_only:this.embeddingOnly,f16_kv:this.f16KV,frequency_penalty:this.frequencyPenalty,logits_all:this.logitsAll,low_vram:this.lowVram,main_gpu:this.mainGpu,mirostat:this.mirostat,mirostat_eta:this.mirostatEta,mirostat_tau:this.mirostatTau,num_batch:this.numBatch,num_ctx:this.numCtx,num_gpu:this.numGpu,num_gqa:this.numGqa,num_keep:this.numKeep,num_predict:this.numPredict,num_thread:this.numThread,penalize_newline:this.penalizeNewline,presence_penalty:this.presencePenalty,repeat_last_n:this.repeatLastN,repeat_penalty:this.repeatPenalty,rope_frequency_base:this.ropeFrequencyBase,rope_frequency_scale:this.ropeFrequencyScale,temperature:this.temperature,stop:e?.stop??this.stop,tfs_z:this.tfsZ,top_k:this.topK,top_p:this.topP,typical_p:this.typicalP,use_mlock:this.useMLock,use_mmap:this.useMMap,vocab_only:this.vocabOnly}}}_combineLLMOutput(){return{}}async*_streamResponseChunksLegacy(e,t,r){const a=async function*(e,t,r){yield*V(`${e}/api/generate`,t,r)}(this.baseUrl,{...this.invocationParams(t),prompt:this._formatMessagesAsPrompt(e)},{...t,headers:this.headers});for await(const e of a)e.done?yield new T({text:"",message:new n.GC({content:""}),generationInfo:{model:e.model,total_duration:e.total_duration,load_duration:e.load_duration,prompt_eval_count:e.prompt_eval_count,prompt_eval_duration:e.prompt_eval_duration,eval_count:e.eval_count,eval_duration:e.eval_duration}}):(yield new T({text:e.response,message:new n.GC({content:e.response})}),await(r?.handleLLMNewToken(e.response??"")))}async*_streamResponseChunks(e,t,r){try{const a=await this.caller.call((async()=>async function*(e,t,r){yield*V(`${e}/api/chat`,t,r)}(this.baseUrl,{...this.invocationParams(t),messages:this._convertMessagesToOllamaMessages(e)},{...t,headers:this.headers})));for await(const e of a)e.done?yield new T({text:"",message:new n.GC({content:""}),generationInfo:{model:e.model,total_duration:e.total_duration,load_duration:e.load_duration,prompt_eval_count:e.prompt_eval_count,prompt_eval_duration:e.prompt_eval_duration,eval_count:e.eval_count,eval_duration:e.eval_duration}}):(yield new T({text:e.message.content,message:new n.GC({content:e.message.content})}),await(r?.handleLLMNewToken(e.message.content??"")))}catch(a){if(404!==a.response?.status)throw a;console.warn("[WARNING]: It seems you are using a legacy version of Ollama. Please upgrade to a newer version for better chat support."),yield*this._streamResponseChunksLegacy(e,t,r)}}_convertMessagesToOllamaMessages(e){return e.map((e=>{let t;if("human"===e._getType())t="user";else if("ai"===e._getType())t="assistant";else{if("system"!==e._getType())throw new Error(`Unsupported message type for Ollama: ${e._getType()}`);t="system"}let r="";const a=[];if("string"==typeof e.content)r=e.content;else for(const t of e.content)if("text"===t.type)r=`${r}\n${t.text}`;else{if("image_url"!==t.type||"string"!=typeof t.image_url)throw new Error('Unsupported message content type. Must either have type "text" or type "image_url" with a string "image_url" field.');{const e=t.image_url.split(",");a.push(e[1]??e[0])}}return{role:t,content:r,images:a}}))}_formatMessagesAsPrompt(e){return e.map((e=>{let t;return"human"===e._getType()?t=`[INST] ${e.content} [/INST]`:"ai"===e._getType()?t=e.content:"system"===e._getType()?t=`<<SYS>> ${e.content} <</SYS>>`:n.J.isInstance(e)?t=`\n\n${e.role[0].toUpperCase()}${e.role.slice(1)}: ${e.content}`:(console.warn(`Unsupported message type passed to Ollama: "${e._getType()}"`),t=""),t})).join("\n")}async _call(e,t,r){const a=[];for await(const n of this._streamResponseChunks(e,t,r))a.push(n.message.content);return a.join("")}}class G{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new w.L(e??{})}}class J extends G{constructor(e){super({maxConcurrency:1,...e}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama2"}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://localhost:11434"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:"5m"}),Object.defineProperty(this,"requestOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e?.model&&(this.model=e.model),e?.baseUrl&&(this.baseUrl=e.baseUrl),e?.headers&&(this.headers=e.headers),e?.keepAlive&&(this.keepAlive=e.keepAlive),e?.requestOptions&&(this.requestOptions=this._convertOptions(e.requestOptions))}_convertOptions(e){const t={},r={embeddingOnly:"embedding_only",f16KV:"f16_kv",frequencyPenalty:"frequency_penalty",keepAlive:"keep_alive",logitsAll:"logits_all",lowVram:"low_vram",mainGpu:"main_gpu",mirostat:"mirostat",mirostatEta:"mirostat_eta",mirostatTau:"mirostat_tau",numBatch:"num_batch",numCtx:"num_ctx",numGpu:"num_gpu",numGqa:"num_gqa",numKeep:"num_keep",numPredict:"num_predict",numThread:"num_thread",penalizeNewline:"penalize_newline",presencePenalty:"presence_penalty",repeatLastN:"repeat_last_n",repeatPenalty:"repeat_penalty",ropeFrequencyBase:"rope_frequency_base",ropeFrequencyScale:"rope_frequency_scale",temperature:"temperature",stop:"stop",tfsZ:"tfs_z",topK:"top_k",topP:"top_p",typicalP:"typical_p",useMLock:"use_mlock",useMMap:"use_mmap",vocabOnly:"vocab_only"};for(const[a,n]of Object.entries(e)){const e=r[a];e&&(t[e]=n)}return t}async _request(e){const{model:t,baseUrl:r,keepAlive:a,requestOptions:n}=this;let i=r;i.startsWith("http://localhost:")&&(i=i.replace("http://localhost:","http://127.0.0.1:"));const s=await fetch(`${i}/api/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",...this.headers},body:JSON.stringify({prompt:e,model:t,keep_alive:a,options:n})});if(!s.ok)throw new Error(`Request to Ollama server failed: ${s.status} ${s.statusText}`);return(await s.json()).embedding}async _embed(e){return await Promise.all(e.map((e=>this.caller.call((()=>this._request(e))))))}async embedDocuments(e){return this._embed(e)}async embedQuery(e){return(await this.embedDocuments([e]))[0]}}class W extends t.eq{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e?.callbacks,this.tags=e?.tags??[],this.metadata=e?.metadata??{},this.verbose=e?.verbose??!1}_getRelevantDocuments(e,t){throw new Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,t)}async getRelevantDocuments(e,t){const r=(0,i.LE)((0,B.QH)(t)),a=await B.Ye.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),n=await(a?.handleRetrieverStart(this.toJSON(),e,void 0,void 0,void 0,void 0,r.runName));try{const t=await this._getRelevantDocuments(e,n);return await(n?.handleRetrieverEnd(t)),t}catch(e){throw await(n?.handleRetrieverError(e)),e}}}function K(e,t){let r=0,a=0,n=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i],a+=e[i]*e[i],n+=t[i]*t[i];return r/(Math.sqrt(a)*Math.sqrt(n))}r(7513),r(6563),Object.prototype.toString;var Q=r(6141);class Z extends W{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,"mmr"===e.searchType&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if("mmr"===this.searchType){if("function"!=typeof this.vectorStore.maxMarginalRelevanceSearch)throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t?.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t?.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class Y extends Q.i{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,t=4,r=void 0,a=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map((e=>e[0]))}async similaritySearchWithScore(e,t=4,r=void 0,a=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,a){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,a,n,i){if("number"==typeof e)return new Z({vectorStore:this,k:e,filter:t,tags:[...a??[],this._vectorstoreType()],metadata:n,verbose:i,callbacks:r});{const t={vectorStore:this,k:e?.k,filter:e?.filter,tags:[...e?.tags??[],this._vectorstoreType()],metadata:e?.metadata,verbose:e?.verbose,callbacks:e?.callbacks,searchType:e?.searchType};return new Z("mmr"===e?.searchType?{...t,searchKwargs:e.searchKwargs}:{...t})}}}class X extends Y{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??K}async addDocuments(e){const t=e.map((({pageContent:e})=>e));return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){const r=e.map(((e,r)=>({content:t[r].pageContent,embedding:e,metadata:t[r].metadata})));this.memoryVectors=this.memoryVectors.concat(r)}async similaritySearchVectorWithScore(t,r,a){const n=this.memoryVectors.filter((t=>{if(!a)return!0;const r=new e({metadata:t.metadata,pageContent:t.content});return a(r)})),i=n.map(((e,r)=>({similarity:this.similarity(t,e.embedding),index:r}))).sort(((e,t)=>e.similarity>t.similarity?-1:0)).slice(0,r).map((t=>[new e({metadata:n[t.index].metadata,pageContent:n[t.index].content}),t.similarity]));return i}static async fromTexts(t,r,a,n){const i=[];for(let a=0;a<t.length;a+=1){const n=Array.isArray(r)?r[a]:r,s=new e({pageContent:t[a],metadata:n});i.push(s)}return X.fromDocuments(i,a,n)}static async fromDocuments(e,t,r){const a=new this(t,r);return await a.addDocuments(e),a}static async fromExistingIndex(e,t){return new this(e,t)}}function ee(e){return Array.isArray?Array.isArray(e):"[object Array]"===se(e)}function te(e){return"string"==typeof e}function re(e){return"number"==typeof e}function ae(e){return"object"==typeof e}function ne(e){return null!=e}function ie(e){return!e.trim().length}function se(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const oe=e=>`Missing ${e} property in key`,le=e=>`Property 'weight' in key '${e}' must be a positive integer`,ce=Object.prototype.hasOwnProperty;class ue{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach((e=>{let r=he(e);this._keys.push(r),this._keyMap[r.id]=r,t+=r.weight})),this._keys.forEach((e=>{e.weight/=t}))}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function he(e){let t=null,r=null,a=null,n=1,i=null;if(te(e)||ee(e))a=e,t=de(e),r=pe(e);else{if(!ce.call(e,"name"))throw new Error(oe("name"));const s=e.name;if(a=s,ce.call(e,"weight")&&(n=e.weight,n<=0))throw new Error(le(s));t=de(s),r=pe(s),i=e.getFn}return{path:t,id:r,weight:n,src:a,getFn:i}}function de(e){return ee(e)?e:e.split(".")}function pe(e){return ee(e)?e.join("."):e}var me={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...{useExtendedSearch:!1,getFn:function(e,t){let r=[],a=!1;const n=(e,t,i)=>{if(ne(e))if(t[i]){const s=e[t[i]];if(!ne(s))return;if(i===t.length-1&&(te(s)||re(s)||function(e){return!0===e||!1===e||function(e){return ae(e)&&null!==e}(e)&&"[object Boolean]"==se(e)}(s)))r.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(s));else if(ee(s)){a=!0;for(let e=0,r=s.length;e<r;e+=1)n(s[e],t,i+1)}else t.length&&n(s,t,i+1)}else r.push(e)};return n(e,te(t)?t.split("."):t,0),a?r:r[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1}};const fe=/[^ ]+/g;class ge{constructor({getFn:e=me.getFn,fieldNormWeight:t=me.fieldNormWeight}={}){this.norm=function(e=1,t=3){const r=new Map,a=Math.pow(10,t);return{get(t){const n=t.match(fe).length;if(r.has(n))return r.get(n);const i=1/Math.pow(n,.5*e),s=parseFloat(Math.round(i*a)/a);return r.set(n,s),s},clear(){r.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach(((e,t)=>{this._keysMap[e.id]=t}))}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,te(this.docs[0])?this.docs.forEach(((e,t)=>{this._addString(e,t)})):this.docs.forEach(((e,t)=>{this._addObject(e,t)})),this.norm.clear())}add(e){const t=this.size();te(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,r=this.size();t<r;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!ne(e)||ie(e))return;let r={v:e,i:t,n:this.norm.get(e)};this.records.push(r)}_addObject(e,t){let r={i:t,$:{}};this.keys.forEach(((t,a)=>{let n=t.getFn?t.getFn(e):this.getFn(e,t.path);if(ne(n))if(ee(n)){let e=[];const t=[{nestedArrIndex:-1,value:n}];for(;t.length;){const{nestedArrIndex:r,value:a}=t.pop();if(ne(a))if(te(a)&&!ie(a)){let t={v:a,i:r,n:this.norm.get(a)};e.push(t)}else ee(a)&&a.forEach(((e,r)=>{t.push({nestedArrIndex:r,value:e})}))}r.$[a]=e}else if(te(n)&&!ie(n)){let e={v:n,n:this.norm.get(n)};r.$[a]=e}})),this.records.push(r)}toJSON(){return{keys:this.keys,records:this.records}}}function be(e,t,{getFn:r=me.getFn,fieldNormWeight:a=me.fieldNormWeight}={}){const n=new ge({getFn:r,fieldNormWeight:a});return n.setKeys(e.map(he)),n.setSources(t),n.create(),n}function ye(e,{errors:t=0,currentLocation:r=0,expectedLocation:a=0,distance:n=me.distance,ignoreLocation:i=me.ignoreLocation}={}){const s=t/e.length;if(i)return s;const o=Math.abs(a-r);return n?s+o/n:o?1:s}const we=32;function ve(e){let t={};for(let r=0,a=e.length;r<a;r+=1){const n=e.charAt(r);t[n]=(t[n]||0)|1<<a-r-1}return t}class _e{constructor(e,{location:t=me.location,threshold:r=me.threshold,distance:a=me.distance,includeMatches:n=me.includeMatches,findAllMatches:i=me.findAllMatches,minMatchCharLength:s=me.minMatchCharLength,isCaseSensitive:o=me.isCaseSensitive,ignoreLocation:l=me.ignoreLocation}={}){if(this.options={location:t,threshold:r,distance:a,includeMatches:n,findAllMatches:i,minMatchCharLength:s,isCaseSensitive:o,ignoreLocation:l},this.pattern=o?e:e.toLowerCase(),this.chunks=[],!this.pattern.length)return;const c=(e,t)=>{this.chunks.push({pattern:e,alphabet:ve(e),startIndex:t})},u=this.pattern.length;if(u>we){let e=0;const t=u%we,r=u-t;for(;e<r;)c(this.pattern.substr(e,we),e),e+=we;if(t){const e=u-we;c(this.pattern.substr(e),e)}}else c(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,includeMatches:r}=this.options;if(t||(e=e.toLowerCase()),this.pattern===e){let t={isMatch:!0,score:0};return r&&(t.indices=[[0,e.length-1]]),t}const{location:a,distance:n,threshold:i,findAllMatches:s,minMatchCharLength:o,ignoreLocation:l}=this.options;let c=[],u=0,h=!1;this.chunks.forEach((({pattern:t,alphabet:d,startIndex:p})=>{const{isMatch:m,score:f,indices:g}=function(e,t,r,{location:a=me.location,distance:n=me.distance,threshold:i=me.threshold,findAllMatches:s=me.findAllMatches,minMatchCharLength:o=me.minMatchCharLength,includeMatches:l=me.includeMatches,ignoreLocation:c=me.ignoreLocation}={}){if(t.length>we)throw new Error("Pattern length exceeds max of 32.");const u=t.length,h=e.length,d=Math.max(0,Math.min(a,h));let p=i,m=d;const f=o>1||l,g=f?Array(h):[];let b;for(;(b=e.indexOf(t,m))>-1;){let e=ye(t,{currentLocation:b,expectedLocation:d,distance:n,ignoreLocation:c});if(p=Math.min(e,p),m=b+u,f){let e=0;for(;e<u;)g[b+e]=1,e+=1}}m=-1;let y=[],w=1,v=u+h;const _=1<<u-1;for(let a=0;a<u;a+=1){let i=0,o=v;for(;i<o;)ye(t,{errors:a,currentLocation:d+o,expectedLocation:d,distance:n,ignoreLocation:c})<=p?i=o:v=o,o=Math.floor((v-i)/2+i);v=o;let l=Math.max(1,d-o+1),b=s?h:Math.min(d+o,h)+u,O=Array(b+2);O[b+1]=(1<<a)-1;for(let i=b;i>=l;i-=1){let s=i-1,o=r[e.charAt(s)];if(f&&(g[s]=+!!o),O[i]=(O[i+1]<<1|1)&o,a&&(O[i]|=(y[i+1]|y[i])<<1|1|y[i+1]),O[i]&_&&(w=ye(t,{errors:a,currentLocation:s,expectedLocation:d,distance:n,ignoreLocation:c}),w<=p)){if(p=w,m=s,m<=d)break;l=Math.max(1,2*d-m)}}if(ye(t,{errors:a+1,currentLocation:d,expectedLocation:d,distance:n,ignoreLocation:c})>p)break;y=O}const O={isMatch:m>=0,score:Math.max(.001,w)};if(f){const e=function(e=[],t=me.minMatchCharLength){let r=[],a=-1,n=-1,i=0;for(let s=e.length;i<s;i+=1){let s=e[i];s&&-1===a?a=i:s||-1===a||(n=i-1,n-a+1>=t&&r.push([a,n]),a=-1)}return e[i-1]&&i-a>=t&&r.push([a,i-1]),r}(g,o);e.length?l&&(O.indices=e):O.isMatch=!1}return O}(e,t,d,{location:a+p,distance:n,threshold:i,findAllMatches:s,minMatchCharLength:o,includeMatches:r,ignoreLocation:l});m&&(h=!0),u+=f,m&&g&&(c=[...c,...g])}));let d={isMatch:h,score:h?u/this.chunks.length:1};return h&&r&&(d.indices=c),d}}class Oe{constructor(e){this.pattern=e}static isMultiMatch(e){return xe(e,this.multiRegex)}static isSingleMatch(e){return xe(e,this.singleRegex)}search(){}}function xe(e,t){const r=e.match(t);return r?r[1]:null}class Pe extends Oe{constructor(e,{location:t=me.location,threshold:r=me.threshold,distance:a=me.distance,includeMatches:n=me.includeMatches,findAllMatches:i=me.findAllMatches,minMatchCharLength:s=me.minMatchCharLength,isCaseSensitive:o=me.isCaseSensitive,ignoreLocation:l=me.ignoreLocation}={}){super(e),this._bitapSearch=new _e(e,{location:t,threshold:r,distance:a,includeMatches:n,findAllMatches:i,minMatchCharLength:s,isCaseSensitive:o,ignoreLocation:l})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class ke extends Oe{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,r=0;const a=[],n=this.pattern.length;for(;(t=e.indexOf(this.pattern,r))>-1;)r=t+n,a.push([t,r-1]);const i=!!a.length;return{isMatch:i,score:i?0:1,indices:a}}}const Ee=[class extends Oe{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},ke,class extends Oe{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends Oe{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends Oe{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends Oe{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends Oe{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},Pe],Te=Ee.length,Se=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/,je=new Set([Pe.type,ke.type]);const Ce=[];function Ae(e,t){for(let r=0,a=Ce.length;r<a;r+=1){let a=Ce[r];if(a.condition(e,t))return new a(e,t)}return new _e(e,t)}const Ie="$and",Me="$path",Re=e=>!(!e[Ie]&&!e.$or),Ne=e=>({[Ie]:Object.keys(e).map((t=>({[t]:e[t]})))});function $e(e,t,{auto:r=!0}={}){const a=e=>{let n=Object.keys(e);const i=(e=>!!e[Me])(e);if(!i&&n.length>1&&!Re(e))return a(Ne(e));if((e=>!ee(e)&&ae(e)&&!Re(e))(e)){const a=i?e[Me]:n[0],s=i?e.$val:e[a];if(!te(s))throw new Error((e=>`Invalid value for key ${e}`)(a));const o={keyId:pe(a),pattern:s};return r&&(o.searcher=Ae(s,t)),o}let s={children:[],operator:n[0]};return n.forEach((t=>{const r=e[t];ee(r)&&r.forEach((e=>{s.children.push(a(e))}))})),s};return Re(e)||(e=Ne(e)),a(e)}function Le(e,t){const r=e.matches;t.matches=[],ne(r)&&r.forEach((e=>{if(!ne(e.indices)||!e.indices.length)return;const{indices:r,value:a}=e;let n={indices:r,value:a};e.key&&(n.key=e.key.src),e.idx>-1&&(n.refIndex=e.idx),t.matches.push(n)}))}function Ue(e,t){t.score=e.score}class De{constructor(e,t={},r){this.options={...me,...t},this.options.useExtendedSearch,this._keyStore=new ue(this.options.keys),this.setCollection(e,r)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof ge))throw new Error("Incorrect 'index' type");this._myIndex=t||be(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){ne(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=(()=>!1)){const t=[];for(let r=0,a=this._docs.length;r<a;r+=1){const n=this._docs[r];e(n,r)&&(this.removeAt(r),r-=1,a-=1,t.push(n))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:r,includeScore:a,shouldSort:n,sortFn:i,ignoreFieldNorm:s}=this.options;let o=te(e)?te(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=me.ignoreFieldNorm}){e.forEach((e=>{let r=1;e.matches.forEach((({key:e,norm:a,score:n})=>{const i=e?e.weight:null;r*=Math.pow(0===n&&i?Number.EPSILON:n,(i||1)*(t?1:a))})),e.score=r}))}(o,{ignoreFieldNorm:s}),n&&o.sort(i),re(t)&&t>-1&&(o=o.slice(0,t)),function(e,t,{includeMatches:r=me.includeMatches,includeScore:a=me.includeScore}={}){const n=[];return r&&n.push(Le),a&&n.push(Ue),e.map((e=>{const{idx:r}=e,a={item:t[r],refIndex:r};return n.length&&n.forEach((t=>{t(e,a)})),a}))}(o,this._docs,{includeMatches:r,includeScore:a})}_searchStringList(e){const t=Ae(e,this.options),{records:r}=this._myIndex,a=[];return r.forEach((({v:e,i:r,n})=>{if(!ne(e))return;const{isMatch:i,score:s,indices:o}=t.searchIn(e);i&&a.push({item:e,idx:r,matches:[{score:s,value:e,norm:n,indices:o}]})})),a}_searchLogical(e){const t=$e(e,this.options),r=(e,t,a)=>{if(!e.children){const{keyId:r,searcher:n}=e,i=this._findMatches({key:this._keyStore.get(r),value:this._myIndex.getValueForItemAtKeyId(t,r),searcher:n});return i&&i.length?[{idx:a,item:t,matches:i}]:[]}const n=[];for(let i=0,s=e.children.length;i<s;i+=1){const s=e.children[i],o=r(s,t,a);if(o.length)n.push(...o);else if(e.operator===Ie)return[]}return n},a=this._myIndex.records,n={},i=[];return a.forEach((({$:e,i:a})=>{if(ne(e)){let s=r(t,e,a);s.length&&(n[a]||(n[a]={idx:a,item:e,matches:[]},i.push(n[a])),s.forEach((({matches:e})=>{n[a].matches.push(...e)})))}})),i}_searchObjectList(e){const t=Ae(e,this.options),{keys:r,records:a}=this._myIndex,n=[];return a.forEach((({$:e,i:a})=>{if(!ne(e))return;let i=[];r.forEach(((r,a)=>{i.push(...this._findMatches({key:r,value:e[a],searcher:t}))})),i.length&&n.push({idx:a,item:e,matches:i})})),n}_findMatches({key:e,value:t,searcher:r}){if(!ne(t))return[];let a=[];if(ee(t))t.forEach((({v:t,i:n,n:i})=>{if(!ne(t))return;const{isMatch:s,score:o,indices:l}=r.searchIn(t);s&&a.push({score:o,key:e,value:t,idx:n,norm:i,indices:l})}));else{const{v:n,n:i}=t,{isMatch:s,score:o,indices:l}=r.searchIn(n);s&&a.push({score:o,key:e,value:n,norm:i,indices:l})}return a}}De.version="7.0.0",De.createIndex=be,De.parseIndex=function(e,{getFn:t=me.getFn,fieldNormWeight:r=me.fieldNormWeight}={}){const{keys:a,records:n}=e,i=new ge({getFn:t,fieldNormWeight:r});return i.setKeys(a),i.setIndexRecords(n),i},De.config=me,De.parseQuery=$e,function(...e){Ce.push(...e)}(class{constructor(e,{isCaseSensitive:t=me.isCaseSensitive,includeMatches:r=me.includeMatches,minMatchCharLength:a=me.minMatchCharLength,ignoreLocation:n=me.ignoreLocation,findAllMatches:i=me.findAllMatches,location:s=me.location,threshold:o=me.threshold,distance:l=me.distance}={}){this.query=null,this.options={isCaseSensitive:t,includeMatches:r,minMatchCharLength:a,findAllMatches:i,ignoreLocation:n,location:s,threshold:o,distance:l},this.pattern=t?e:e.toLowerCase(),this.query=function(e,t={}){return e.split("|").map((e=>{let r=e.trim().split(Se).filter((e=>e&&!!e.trim())),a=[];for(let e=0,n=r.length;e<n;e+=1){const n=r[e];let i=!1,s=-1;for(;!i&&++s<Te;){const e=Ee[s];let r=e.isMultiMatch(n);r&&(a.push(new e(r,t)),i=!0)}if(!i)for(s=-1;++s<Te;){const e=Ee[s];let r=e.isSingleMatch(n);if(r){a.push(new e(r,t));break}}}return a}))}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:r,isCaseSensitive:a}=this.options;e=a?e:e.toLowerCase();let n=0,i=[],s=0;for(let a=0,o=t.length;a<o;a+=1){const o=t[a];i.length=0,n=0;for(let t=0,a=o.length;t<a;t+=1){const a=o[t],{isMatch:l,indices:c,score:u}=a.search(e);if(!l){s=0,n=0,i.length=0;break}if(n+=1,s+=u,r){const e=a.constructor.type;je.has(e)?i=[...i,...c]:i.push(c)}}if(n){let e={isMatch:!0,score:s/n};return r&&(e.indices=i),e}}return{isMatch:!1,score:1}}});var Fe=function(e,t,r,a){return new(r||(r=Promise))((function(n,i){function s(e){try{l(a.next(e))}catch(e){i(e)}}function o(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,o)}l((a=a.apply(e,t||[])).next())}))};class Be extends W{static lc_name(){return"EnhancedMemoryRetriever"}get lc_namespace(){return["chat","vectorstores"]}constructor(e){var t,r;super(e),this.k=4,this.searchType="similarity",this.vectorStore=e.vectorStore,this.k=null!==(t=e.k)&&void 0!==t?t:this.k,this.searchType=null!==(r=e.searchType)&&void 0!==r?r:this.searchType,this.filter=e.filter}_vectorstoreType(){return this.vectorStore._vectorstoreType()}_getRelevantDocuments(e,t){return Fe(this,void 0,void 0,(function*(){return"similarity"===this.searchType?this.vectorStore.similaritySearch(e,this.k,this.filter,null==t?void 0:t.getChild("vectorstore")):"keyword"===this.searchType?this.vectorStore.keywordSearch(e,this.k,this.filter):this.vectorStore.hybridSearch(e,this.k,this.filter,null==t?void 0:t.getChild("vectorstore"))}))}addDocuments(e){return Fe(this,void 0,void 0,(function*(){return yield this.vectorStore.addDocuments(e)}))}}class ze extends X{_vectorstoreType(){return"enhanced-memory"}keywordSearch(e,t,r){return Fe(this,void 0,void 0,(function*(){return(yield this.keywordSearchWithScore(e,t,r)).map((e=>e[0]))}))}keywordSearchWithScore(t,r,a){return Fe(this,void 0,void 0,(function*(){const n=this.memoryVectors.filter((t=>{if(!a)return!0;const r=new e({metadata:t.metadata,pageContent:t.content});return a(r)})).map((e=>({metadata:e.metadata,pageContent:e.content}))),i=new De(n,{includeScore:!0,ignoreLocation:!0,keys:["pageContent"]}).search(t,{limit:r});return Promise.all(i).then((t=>t.map((t=>[new e(t.item),t.score]))))}))}hybridSearch(e,t,r,a){return Fe(this,void 0,void 0,(function*(){const n=yield this.similaritySearchWithScore(e,t,r,a).then((e=>e.map((e=>{const t=(e[1]+1)/2;return e[1]=t,e}))));console.log("Similarity search results: ",n);const i=yield this.keywordSearchWithScore(e,t,r).then((e=>e.map((e=>{const t=.7*e[1];return e[1]=t,e}))));return console.log("Keyword search results: ",i),Promise.all([n,i]).then((e=>e.flat())).then((e=>{const t=new Map;return e.forEach((e=>{var r;const a=e[0].metadata.docId,n=e[1],i=null===(r=t.get(a))||void 0===r?void 0:r[1];(void 0===i||n>i)&&t.set(a,e)})),Array.from(t.values())})).then((e=>e.sort(((e,t)=>t[1]-e[1])))).then((e=>e.slice(0,t))).then((e=>e.map((e=>e[0]))))}))}asRetriever(e,t,r,a,n,i){var s;if("number"==typeof e)return new Be({vectorStore:this,k:e,filter:t,tags:[...null!=a?a:[],this._vectorstoreType()],metadata:n,verbose:i,callbacks:r});{const t={vectorStore:this,k:null==e?void 0:e.k,filter:null==e?void 0:e.filter,tags:[...null!==(s=null==e?void 0:e.tags)&&void 0!==s?s:[],this._vectorstoreType()],metadata:null==e?void 0:e.metadata,verbose:null==e?void 0:e.verbose,callbacks:null==e?void 0:e.callbacks,searchType:null==e?void 0:e.searchType};return new Be(Object.assign({},t))}}}const qe=JSON.stringify({default:{chunkSize:1e3,chunkOverlap:0,selectors:["body"],selectorsAll:[]}},null,2),Ve={Calculator:{enabled:!0,prefix:"calculate:"}},He=()=>({ollamaModel:"37100-finetuned:latest",ollamaHost:"http://localhost:11434",contentConfig:JSON.parse(qe),vectorStoreTTLMins:60,toolConfig:Ve});var Ge=function(e,t,r,a){return new(r||(r=Promise))((function(n,i){function s(e){try{l(a.next(e))}catch(e){i(e)}}function o(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,o)}l((a=a.apply(e,t||[])).next())}))};const Je=new Map;let We="",Ke="";const Qe=e=>new H({baseUrl:e.ollamaHost,model:e.ollamaModel,keepAlive:"60m",callbacks:[new d.Z]}),Ze=()=>Ge(void 0,void 0,void 0,(function*(){let e=[];const t=yield chrome.storage.session.get(["messages"]);return t.messages&&(e=t.messages.slice(-3).map((e=>"user"===e.sender?new n.xk({content:e.message}):new n.gY({content:e.message})))),e})),Ye=e=>Math.ceil(Math.sqrt(e)),Xe=e=>{var t,r,a;return Ge(void 0,void 0,void 0,(function*(){var n,i,s,o;Ke="";try{for(t=!0,r=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},a("next"),a("throw"),a("return"),t[Symbol.asyncIterator]=function(){return this},t);function a(r){t[r]=e[r]&&function(t){return new Promise((function(a,n){!function(e,t,r,a){Promise.resolve(a).then((function(t){e({value:t,done:r})}),t)}(a,n,(t=e[r](t)).done,t.value)}))}}}(e);!(n=(a=yield r.next()).done);){o=a.value,t=!1;try{Ke+=o,chrome.runtime.sendMessage({completion:Ke,sender:"assistant"}).catch((()=>{console.log("Sending partial completion, but popup is closed...")}))}finally{t=!0}}}catch(e){i={error:e}}finally{try{t||n||!(s=r.return)||(yield s.call(r))}finally{if(i)throw i.error}}chrome.runtime.sendMessage({done:!0}).catch((()=>{console.log("Sending done message, but popup is closed..."),chrome.storage.sync.set({completion:Ke,sender:"assistant"})}))}))};chrome.runtime.onMessage.addListener((r=>Ge(void 0,void 0,void 0,(function*(){var a;if(r.prompt&&r.skipRAG){const e=r.prompt.trim();console.log(`Received prompt (RAG disabled): ${e}`);const t=He(),a=h.ks.fromMessages(yield Ze()),n=Qe(t),i=a.pipe(n).pipe(new u),s=yield i.stream({});Xe(s)}if(r.prompt&&!r.skipRAG){const n=r.prompt.trim(),i=r.url,s=Boolean(r.skipCache);console.log(`Received prompt (RAG enabled): ${n}`),console.log(`Received url: ${i}`);const o=He(),l=o.contentConfig.default,c=r.chunkSize?r.chunkSize:l.chunkSize,p=r.chunkOverlap?r.chunkOverlap:l.chunkOverlap;let m,f;if(console.log(`Received chunk size: ${c} and chunk overlap: ${p}`),Je.forEach(((e,t)=>{Date.now()-e.createdAt>60*o.vectorStoreTTLMins*1e3&&(Je.delete(t),console.log(`Deleting vector store for url: ${t}`))})),!s&&Je.has(i))console.log(`Retrieving existing vector store for url: ${i}`),m=null===(a=Je.get(i))||void 0===a?void 0:a.vectorStore,f=m.memoryVectors.length;else{console.log(`Creating ${s?"temporary":"new"} vector store for url: ${i}`);const t=new x({chunkSize:c,chunkOverlap:p}),r=yield t.createDocuments([We]);f=r.length,m=new ze(new J({baseUrl:o.ollamaHost,model:o.ollamaModel,keepAlive:"60m"})),r.forEach(((t,r)=>Ge(void 0,void 0,void 0,(function*(){yield m.addDocuments([new e({pageContent:t.pageContent,metadata:Object.assign(Object.assign({},t.metadata),{docId:r})})]),chrome.runtime.sendMessage({docNo:r+1,docCount:f,skipCache:s}).catch((()=>{console.log("Sending document embedding message, but popup is closed...")}))})))),s||Je.set(i,{vectorStore:m,createdAt:Date.now()})}const g=m.asRetriever({k:Ye(f),searchType:"hybrid",callbacks:[new d.Z]}),b=h.ks.fromMessages([h.ov.fromTemplate("Use the following context when responding to the prompt.\n\nBEGIN CONTEXT\n\n{filtered_context}\n\nEND CONTEXT"),...yield Ze()]),y=Qe(o),w=t.lW.from([{filtered_context:g.pipe(P)},b,y,new u]),v=yield w.stream(n);Xe(v)}r.context&&(We=r.context,console.log(`Received context: ${We}`))}))));const et=()=>{setInterval(chrome.runtime.getPlatformInfo,2e4),console.log("Keep alive...")};chrome.runtime.onStartup.addListener(et),et()})()})();